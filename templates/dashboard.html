<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPS Y√∂netim Paneli v3.1</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        success: '#22c55e',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                    }
                }
            }
        }
    </script>

    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* DataTables Customization */
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_processing,
        .dataTables_wrapper .dataTables_paginate {
            color: #475569;
            margin-bottom: 10px;
        }

        table.dataTable thead th {
            padding: 12px 10px;
            background-color: #f8fafc;
            color: #475569;
            border-bottom: 2px solid #e2e8f0;
        }

        table.dataTable tbody td {
            padding: 10px;
            border-bottom: 1px solid #f1f5f9;
        }

        .modal {
            transition: opacity 0.3s ease;
        }

        .modal-content {
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }
    </style>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-slate-50 text-slate-800 font-sans antialiased">

    <!-- Mobile Header -->
    <div class="lg:hidden bg-white shadow-sm p-4 flex justify-between items-center sticky top-0 z-20">
        <h1 class="text-xl font-bold text-primary flex items-center gap-2">
            <i class="fa-solid fa-industry"></i> EPS Panel
        </h1>
        <button onclick="toggleSidebar()" class="text-slate-600 hover:text-primary">
            <i class="fa-solid fa-bars text-2xl"></i>
        </button>
    </div>

    <div class="flex h-screen overflow-hidden">

        <!-- Sidebar -->
        <aside id="sidebar"
            class="fixed inset-y-0 left-0 bg-slate-900 text-white w-64 transform -translate-x-full lg:relative lg:translate-x-0 transition-transform duration-300 ease-in-out z-30 flex flex-col shadow-xl">
            <div class="p-6 border-b border-slate-800 flex justify-between items-center">
                <h1 class="text-2xl font-bold flex items-center gap-2">
                    <i class="fa-solid fa-cubes text-blue-400"></i> EPS v3.1
                </h1>
                <button onclick="toggleSidebar()" class="lg:hidden text-slate-400 hover:text-white">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <nav class="flex-1 overflow-y-auto p-4 space-y-2">
                <!-- 1. Ana Sayfa (Dashboard) -->
                <a href="#" onclick="showSection('section-dashboard', this)"
                    class="nav-item block px-4 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition">
                    <i class="fa-solid fa-house w-6"></i> Ana Sayfa
                </a>

                <!-- 2. Yeni Sipari≈ü Giri≈üi -->
                <a href="#" onclick="showSection('section-new-order', this)"
                    class="nav-item block px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition">
                    <i class="fa-solid fa-plus-circle w-6"></i> Yeni Sipari≈ü Giri≈üi
                </a>

                <!-- 3. Bekleyen Sipari≈üler -->
                <a href="#" onclick="showSection('section-pending-orders', this)"
                    class="nav-item block px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition">
                    <i class="fa-solid fa-clipboard-list w-6"></i> Bekleyen Sipari≈üler
                </a>

                <!-- 3. √úretim Hareketleri (Ham/Zemin) -->
                <a href="#" onclick="showSection('section-production', this)"
                    class="nav-item block px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition">
                    <i class="fa-solid fa-dolly w-6"></i> √úretim Hareketleri
                </a>

                <!-- 4. Stok G√∂r√ºn√ºm√º & Tanƒ±mlar -->
                <a href="#" onclick="showSection('section-stock-defs', this)"
                    class="nav-item block px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition">
                    <i class="fa-solid fa-layer-group w-6"></i> Stok G√∂r√ºn√ºm√º
                </a>

                <!-- 5. G√ºnl√ºk √úretim ve Sevkiyat Planƒ± -->
                <a href="#" onclick="showSection('section-daily-plan', this)"
                    class="nav-item block px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition">
                    <i class="fa-solid fa-calendar-days w-6"></i> G√ºnl√ºk Plan
                </a>

                <!-- 6. Sipari≈ü Analizi -->
                <a href="#" onclick="showSection('section-analysis', this)"
                    class="nav-item block px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition">
                    <i class="fa-solid fa-chart-pie w-6"></i> Sipari≈ü Analizi
                </a>

                <!-- 7. Zemin Analizi -->
                <a href="#" onclick="showSection('section-zemin-analysis', this)"
                    class="nav-item block px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition">
                    <i class="fa-solid fa-layer-group w-6"></i> Zemin Analizi
                </a>

                <div class="my-4 border-t border-slate-700"></div>

                <a href="{{ url_for('mobil_gorunum') }}"
                    class="block px-4 py-3 text-slate-300 hover:bg-slate-800 rounded-lg transition" target="_blank">
                    <i class="fa-solid fa-mobile-screen w-6"></i> Mobil G√∂r√ºn√ºm
                </a>

                <div class="mt-4 px-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">
                    Sistem Ara√ßlarƒ±
                </div>
                <!-- Capacity Settings inline wrapper -->
                <div class="bg-slate-800/50 rounded-lg p-3 mt-2 border border-slate-700">
                    <form action="/ayarla/kapasite" method="POST" class="space-y-2">
                        <label class="text-xs text-slate-400">G√ºnl√ºk Sƒ±va Kapasitesi (m¬≤)</label>
                        <div class="flex gap-2">
                            <input type="number" name="kapasite_m2" value="{{ gunluk_siva_m2 }}"
                                class="w-full bg-slate-700 border border-slate-600 rounded px-2 py-1 text-sm text-white focus:outline-none focus:border-blue-500">
                            <button type="submit"
                                class="bg-blue-600 hover:bg-blue-500 px-3 rounded text-white text-xs">Kaydet</button>
                        </div>
                    </form>
                </div>

                <div class="mt-auto px-4 pt-4">
                    <p class="text-[10px] text-slate-500 text-center">v3.1 SPA Edition</p>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto h-full p-4 lg:p-8 relative">

            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="fixed top-4 right-4 z-50 flex flex-col gap-2 w-full max-w-sm">
                {% for category, message in messages %}
                <div
                    class="p-4 rounded-lg shadow-lg border-l-4 flex items-center justify-between {{ 'bg-green-100 border-green-500 text-green-800' if category == 'success' else 'bg-red-100 border-red-500 text-red-800' if 'Hata' in message or category == 'error' else 'bg-blue-100 border-blue-500 text-blue-800' }}">
                    <div class="flex items-center gap-2">
                        <i
                            class="fa-solid {{ 'fa-circle-check' if category == 'success' else 'fa-circle-exclamation' }}"></i>
                        <span class="font-medium text-sm">{{ message }}</span>
                    </div>
                    <button onclick="this.parentElement.remove()"
                        class="text-lg opacity-50 hover:opacity-100">&times;</button>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}

            {% if message %}
            <!-- Query param message fallback -->
            <div
                class="mb-6 p-4 rounded-lg shadow-sm border-l-4 {{ 'bg-red-50 border-red-500 text-red-700' if 'Hata' in message or 'Yetersiz' in message else 'bg-green-50 border-green-500 text-green-700' }}">
                <p class="font-medium">{{ message }}</p>
            </div>
            {% endif %}

            <!-- SECTIONS CONTAINER -->
            <div id="main-sections-container">

                <!-- 1. DASHBOARD OVERVIEW -->
                <div id="section-dashboard" class="content-section space-y-6">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">Genel Durum</h2>
                        <p class="text-sm text-slate-500">Fabrika √ºretim ve sipari≈ü √∂zeti</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <!-- Total Order M2 -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 cursor-pointer hover:shadow-md transition"
                            onclick="showSection('section-pending-orders')">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wide">Toplam Sipari≈ü
                                        Miktarƒ± (Aktif)</p>
                                    <h3 class="text-3xl font-bold text-slate-800 mt-2">
                                        {{ siparisler|sum(attribute='bekleyen_m2')|round(1) }} <span
                                            class="text-lg font-normal text-slate-400">m¬≤</span>
                                    </h3>
                                </div>
                                <div class="p-3 bg-indigo-50 text-indigo-600 rounded-xl">
                                    <i class="fa-solid fa-layer-group text-2xl"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Pending Order M2 -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 cursor-pointer hover:shadow-md transition"
                            onclick="showSection('section-pending-orders')">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wide">Bekleyen Sipari≈ü
                                        Miktarƒ±</p>
                                    <h3 class="text-3xl font-bold text-slate-800 mt-2">
                                        {{ toplam_bekleyen_siparis_m2 }} <span
                                            class="text-lg font-normal text-slate-400">m¬≤</span>
                                    </h3>
                                </div>
                                <div class="p-3 bg-blue-50 text-blue-600 rounded-xl">
                                    <i class="fa-solid fa-clock text-2xl"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Stock Warning -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 cursor-pointer hover:shadow-md transition"
                            onclick="showSection('section-stock-defs')">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wide">√úretilmesi
                                        Gereken</p>
                                    <h3
                                        class="text-3xl font-bold {{ 'text-red-500' if toplam_gerekli_siva > 0 else 'text-green-500' }} mt-2">
                                        {{ toplam_gerekli_siva }} <span
                                            class="text-lg font-normal text-slate-400">m¬≤</span>
                                    </h3>
                                </div>
                                <div class="p-3 bg-red-50 text-red-600 rounded-xl">
                                    <i class="fa-solid fa-fire text-2xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div
                        class="hidden lg:block bg-gradient-to-r from-slate-800 to-slate-900 rounded-2xl p-8 text-white relative overflow-hidden shadow-2xl">
                        <div class="relative z-10 max-w-2xl">
                            <h2 class="text-3xl font-bold mb-4">Ho≈ügeldiniz</h2>
                            <p class="text-slate-300 text-lg mb-6">EPS Y√∂netim Paneli v3.1 g√ºncel versiyonu ile
                                hizmetinizde. Sol men√ºy√º kullanarak √ºretim planlayabilir veya yeni sipari≈ü
                                girebilirsiniz.</p>
                            <button
                                onclick="showSection('section-new-order', document.querySelector('a[onclick*=\'section-new-order\']'))"
                                class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-lg font-bold transition shadow-lg shadow-blue-500/30">
                                Yeni Sipari≈ü Olu≈ütur
                            </button>
                        </div>
                        <!-- Decorative Blob -->
                        <div class="absolute right-0 top-0 h-full w-1/3 bg-white/5 skew-x-12 transform translate-x-10">
                        </div>
                    </div>
                </div>

                <!-- 2. NEW ORDER -->
                <div id="section-new-order" class="content-section hidden">
                    <div
                        class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden max-w-4xl mx-auto">
                        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-4">
                            <h2 class="text-white font-bold flex items-center gap-2">
                                <i class="fa-solid fa-plus-circle"></i> Yeni Sipari≈ü Giri≈üi
                            </h2>
                        </div>
                        <div class="p-6">
                            <form action="/siparis" method="POST" id="newOrderForm">
                                <input type="hidden" name="action" value="yeni_siparis">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-base font-medium text-slate-700 mb-1">M√º≈üteri
                                            Adƒ±</label>
                                        <input type="text" name="musteri" required
                                            class="w-full rounded-lg border-slate-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 shadow-sm text-base py-2 px-3"
                                            placeholder="Firma veya Ki≈üi Adƒ±">
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-base font-medium text-slate-700 mb-1">Sipari≈ü
                                                Tarihi</label>
                                            <input type="date" name="siparis_tarihi" value="{{ today }}" required
                                                class="w-full rounded-lg border-slate-300 shadow-sm text-base py-2">
                                        </div>
                                        <div>
                                            <label class="block text-base font-medium text-slate-700 mb-1">Termin
                                                Tarihi</label>
                                            <input type="date" name="termin_tarihi" required
                                                class="w-full rounded-lg border-slate-300 shadow-sm text-base py-2">
                                        </div>
                                    </div>
                                    <div class="border-t border-slate-100 pt-4">
                                        <label class="block text-base font-medium text-slate-700 mb-2">√úr√ºnler</label>
                                        <div id="siparis-urun-container" class="space-y-3"></div>
                                        <button type="button" onclick="addRow(1)"
                                            class="mt-3 w-full py-3 border-2 border-dashed border-slate-300 text-slate-500 rounded-lg hover:border-blue-500 hover:text-blue-500 transition text-base font-medium">
                                            <i class="fa-solid fa-plus"></i> Satƒ±r Ekle
                                        </button>
                                    </div>
                                </div>
                                <button type="submit"
                                    class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition transform active:scale-95">
                                    Sipari≈üi Kaydet
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- 3. PRODUCTION (Stock Ops) -->
                <div id="section-production" class="content-section hidden">
                    <div
                        class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden max-w-4xl mx-auto">
                        <div class="bg-slate-100 px-6 py-4 border-b border-slate-200">
                            <h2 class="text-slate-700 font-bold flex items-center gap-2">
                                <i class="fa-solid fa-arrow-right-arrow-left"></i> √úretim & Stok Hareketleri
                            </h2>
                        </div>
                        <div class="p-6 space-y-6">
                            <!-- Stock Action Form (MOVED DEFINITIONS TO STOCK SECTION) -->
                            <form action="/islem" method="POST" class="space-y-3">
                                <div>
                                    <label class="block text-xs font-semibold text-slate-500 mb-1">ƒ∞≈ülem Tipi</label>
                                    <select name="action" class="w-full rounded-lg border-slate-300 text-sm py-2">
                                        <option value="ham_alim">üì• Ham Alƒ±mƒ± (Giri≈ü)</option>
                                        <option value="siva_uygula">üî® Sƒ±va Uygula (Ham -> Sƒ±valƒ±)</option>
                                        <option value="sat_sivali">üì¶ Sƒ±valƒ± Satƒ±≈ü (√áƒ±kƒ±≈ü)</option>
                                        <option value="sat_ham">üì¶ Ham Satƒ±≈ü (√áƒ±kƒ±≈ü)</option>
                                        <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                                        <option value="iptal_ham_alim">‚Ü©Ô∏è Alƒ±m ƒ∞ptal</option>
                                        <option value="iptal_siva">‚Ü©Ô∏è Sƒ±va ƒ∞ptal</option>
                                        <option value="iptal_sat_sivali">‚Ü©Ô∏è Sƒ±valƒ± Satƒ±≈ü ƒ∞ptal</option>
                                    </select>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <select name="cinsi" class="w-full rounded-lg border-slate-300 text-sm">
                                        {% for c in CINSLER %}<option value="{{ c }}">{{ c }}</option>{% endfor %}
                                    </select>
                                    <select name="kalinlik" class="w-full rounded-lg border-slate-300 text-sm">
                                        {% for k in KALINLIKLAR %}<option value="{{ k }}">{{ k }}</option>{% endfor %}
                                    </select>
                                </div>
                                <input type="number" name="m2" min="1" required placeholder="Miktar (m¬≤)"
                                    class="w-full rounded-lg border-slate-300 text-sm py-2">
                                <button type="submit"
                                    class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-2 rounded-lg transition">
                                    ƒ∞≈ülemi Uygula
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- 4. STOCK OVERVIEW & DEFINITIONS -->
                <div id="section-stock-defs" class="content-section hidden">
                    <!-- Definitions Forms (Moved from Production) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-orange-100">
                            <h4 class="text-sm font-bold text-orange-800 uppercase mb-3 flex items-center gap-2">
                                <i class="fa-solid fa-plus"></i> Yeni √úr√ºn Tanƒ±mƒ± Ekle
                            </h4>
                            <form action="/ayarla/kalinlik" method="POST" class="flex gap-2">
                                <input type="text" name="yeni_cins" placeholder="Cins (√ñrn: LBX)"
                                    class="w-1/3 text-sm px-3 py-2 rounded border border-slate-200 focus:border-orange-500 outline-none"
                                    required>
                                <input type="text" name="yeni_kalinlik" placeholder="Kalƒ±nlƒ±k (√ñrn: 1.5)"
                                    class="w-1/3 text-sm px-3 py-2 rounded border border-slate-200 focus:border-orange-500 outline-none"
                                    required>
                                <button
                                    class="w-1/3 bg-orange-600 text-white text-sm font-bold rounded hover:bg-orange-700 transition">Kaydet</button>
                            </form>
                            <p class="text-[10px] text-slate-400 mt-2">Bu i≈ülem yeni bir Cins/Kalƒ±nlƒ±k kombinasyonu
                                yaratƒ±r.</p>
                        </div>

                        <div class="bg-white p-5 rounded-xl shadow-sm border border-cyan-100">
                            <h4 class="text-sm font-bold text-cyan-800 uppercase mb-3 flex items-center gap-2">
                                <i class="fa-solid fa-barcode"></i> Yeni √úr√ºn Kodu Ekle
                            </h4>
                            <form action="/ayarla/urun_kodu" method="POST" class="flex gap-2">
                                <input type="text" name="yeni_urun_kodu" placeholder="Kod (√ñrn: L101)"
                                    class="w-1/3 text-sm px-3 py-2 rounded border border-slate-200 focus:border-cyan-500 outline-none"
                                    required>
                                <select name="cinsi"
                                    class="w-1/3 text-sm px-3 py-2 rounded border border-slate-200 focus:border-cyan-500 outline-none"
                                    required>
                                    <option value="" disabled selected>√úr√ºn Se√ß</option>
                                    {% for c in CINSLER %}
                                    {% for k in KALINLIKLAR %}
                                    <option value="{{ c }} {{ k }}">{{ c }} {{ k }}</option>
                                    {% endfor %}
                                    {% endfor %}
                                </select>
                                <button
                                    class="w-1/3 bg-cyan-600 text-white text-sm font-bold rounded hover:bg-cyan-700 transition">Kaydet</button>
                            </form>
                            <p class="text-[10px] text-slate-400 mt-2">Mevcut bir √ºr√ºne yeni bir varyant kodu ekler.</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="p-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700">Detaylƒ± Stok G√∂r√ºn√ºm√º</h3>
                            <span class="text-xs text-slate-500">Anlƒ±k ham ve sƒ±valƒ± stok durumlarƒ±</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-slate-500 uppercase bg-slate-50">
                                    <tr>
                                        <th class="px-4 py-3">√úr√ºn</th>
                                        <th class="px-4 py-3 text-right">Ham Stok</th>
                                        <th class="px-4 py-3 text-right">Sƒ±valƒ± Stok</th>
                                        <th class="px-4 py-3 text-right bg-blue-50">Bekleyen</th>
                                        <th class="px-4 py-3 text-right text-red-600 bg-red-50">Eksik (Sƒ±valƒ±)</th>
                                        <th class="px-4 py-3 text-right text-orange-600 bg-orange-50">Eksik (Ham)</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    {% for s in stok_list %}
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-4 py-2 font-medium">{{ s.cinsi }} {{ s.kalinlik }}</td>
                                        <td class="px-4 py-2 text-right text-slate-600">{{ s.ham_m2 }}</td>
                                        <td class="px-4 py-2 text-right text-slate-600">{{ s.sivali_m2 }}</td>
                                        <td class="px-4 py-2 text-right font-bold bg-blue-50/30">{{ s.gerekli_siparis_m2
                                            }}</td>
                                        <td class="px-4 py-2 text-right font-bold text-red-600 bg-red-50/30">{{
                                            s.sivali_eksik }}</td>
                                        <td class="px-4 py-2 text-right font-bold text-orange-600 bg-orange-50/30">{{
                                            s.ham_eksik }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 5. DAILY PLAN -->
                <div id="section-daily-plan" class="content-section hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Plaster Plan -->
                        <div class="bg-emerald-50 rounded-xl p-5 border border-emerald-100">
                            <h3 class="font-bold text-emerald-800 mb-3 flex items-center gap-2">
                                <i class="fa-solid fa-calendar-week"></i> 5 G√ºnl√ºk √úretim Planƒ±
                            </h3>
                            {% if siva_plan_detay %}
                            <div class="space-y-3">
                                {% for gun, details in siva_plan_detay.items() %}
                                <div class="bg-white p-3 rounded-lg shadow-sm">
                                    <div class="flex justify-between items-center mb-2 border-b border-emerald-50 pb-1">
                                        <span class="font-bold text-emerald-700">G√ºn {{ gun }}</span>
                                        <span
                                            class="text-sm bg-emerald-100 text-emerald-800 px-2 py-0.5 rounded-full font-bold">{{
                                            details|sum(attribute='m2') }} m¬≤</span>
                                    </div>
                                    <ul class="text-sm text-slate-600 space-y-1">
                                        {% for item in details %}
                                        <li>‚Ä¢ {{ item.cinsi }}: <b>{{ item.m2 }}</b> m¬≤</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <p class="text-sm text-emerald-600 italic">Planlanan √ºretim yok.</p>
                            {% endif %}
                        </div>

                        <!-- Shipment Plan -->
                        <div class="bg-amber-50 rounded-xl p-5 border border-amber-100">
                            <h3 class="font-bold text-amber-800 mb-3 flex items-center gap-2">
                                <i class="fa-solid fa-truck-fast"></i> Sevkiyat Planƒ±
                            </h3>
                            {% if sevkiyat_plan_detay %}
                            <div class="space-y-4">
                                {% for tarih, musteriler in sevkiyat_plan_detay.items() %}
                                <div class="bg-white p-3 rounded-lg shadow-sm border border-amber-100">
                                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-amber-50">
                                        <div class="flex items-center gap-2">
                                            <i class="fa-regular fa-calendar text-amber-500"></i>
                                            <span class="font-bold text-amber-800 text-sm">{{ tarih }}</span>
                                        </div>
                                    </div>
                                    <div class="space-y-3">
                                        {% for musteri, urunler in musteriler.items() %}
                                        <div class="bg-slate-50 rounded p-2 border border-slate-100">
                                            <div class="flex justify-between items-center mb-2">
                                                <h5 class="text-xs font-bold text-slate-800 flex items-center gap-1">
                                                    <i class="fa-solid fa-user text-blue-400 text-[10px]"></i> {{
                                                    musteri }}
                                                </h5>
                                                <span
                                                    class="text-[10px] font-bold text-slate-500 bg-white px-2 py-0.5 rounded border border-slate-200">
                                                    {{ urunler|sum(attribute='bekleyen_m2') }} m¬≤
                                                </span>
                                            </div>
                                            <ul class="space-y-1 pl-2 border-l-2 border-blue-200/50">
                                                {% for s in urunler %}
                                                <li
                                                    class="flex justify-between text-[11px] hover:bg-white/50 rounded px-1 transition">
                                                    <span class="text-slate-600 font-mono">{{ s.urun_kodu }}</span>
                                                    <span class="font-semibold text-slate-700">{{ s.bekleyen_m2 }}
                                                        m¬≤</span>
                                                </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <p class="text-sm text-amber-600 italic">Yakƒ±n sevkiyat yok.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- 6. PENDING ORDERS -->
                <div id="section-pending-orders" class="content-section hidden">
                    <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                        <div
                            class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                            <h2 class="text-xl font-bold text-slate-800">Sipari≈ü Listesi</h2>
                            <span class="bg-slate-100 text-slate-600 px-4 py-1 rounded-full text-sm font-semibold">
                                Toplam Bekleyen: {{ toplam_bekleyen_siparis_m2 }} m¬≤
                            </span>
                        </div>
                        <div class="p-6 overflow-x-auto">
                            <!-- Bulk Action Toolbar -->
                            <div id="bulkActionToolbar"
                                class="hidden bg-blue-50 p-3 mb-4 rounded-lg flex items-center justify-between border border-blue-100 transition-all">
                                <span class="text-sm font-bold text-blue-700 flex items-center gap-2">
                                    <i class="fa-solid fa-check-double"></i> <span id="selectedCount">0</span> sipari≈ü
                                    se√ßildi
                                </span>
                                <div class="flex gap-2">
                                    <button onclick="openBulkDateModal()"
                                        class="text-xs bg-white text-blue-600 hover:bg-blue-600 hover:text-white border border-blue-200 px-3 py-2 rounded font-medium transition">
                                        <i class="fa-solid fa-calendar-days mr-1"></i> Tarih G√ºncelle
                                    </button>
                                    <button onclick="submitBulkAction('tamamla_toplu')"
                                        class="text-xs bg-white text-green-600 hover:bg-green-600 hover:text-white border border-green-200 px-3 py-2 rounded font-medium transition">
                                        <i class="fa-solid fa-check mr-1"></i> Tamamla
                                    </button>
                                    <button onclick="submitBulkAction('sil_toplu')"
                                        class="text-xs bg-white text-red-600 hover:bg-red-600 hover:text-white border border-red-200 px-3 py-2 rounded font-medium transition">
                                        <i class="fa-solid fa-trash mr-1"></i> Sil
                                    </button>
                                </div>
                            </div>

                            <table id="ordersTable" class="w-full text-left border-collapse hidden md:table">
                                <thead>
                                    <tr>
                                        <!-- ID Column Hidden mobile -->
                                        <th class="w-4 p-4">
                                            <div class="flex items-center">
                                                <input id="checkbox-all" type="checkbox"
                                                    class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"
                                                    onclick="toggleAllCheckboxes(this)">
                                            </div>
                                        </th>
                                        <th class="hidden md:table-cell">ID</th>
                                        <th>M√º≈üteri</th>
                                        <th>Kod</th>
                                        <th class="hidden sm:table-cell">Detay</th>
                                        <th class="hidden sm:table-cell">Sipari≈ü Tar.</th>
                                        <th>Termin Tar.</th>
                                        <th>M¬≤</th>
                                        <th>Durum</th>
                                        <th>ƒ∞≈ülemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for siparis in siparisler %}
                                    <tr
                                        class="hover:bg-slate-50 transition {{ 'bg-green-50/50' if siparis.durum == 'Tamamlandi' }}">
                                        <td class="w-4 p-4">
                                            <div class="flex items-center">
                                                <input type="checkbox" name="siparis_ids[]" value="{{ siparis.id }}"
                                                    class="order-checkbox w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"
                                                    onchange="updateBulkToolbar()">
                                            </div>
                                        </td>
                                        <td class="hidden md:table-cell text-sm text-slate-400 font-mono">#{{ siparis.id
                                            }}</td>
                                        <td class="text-base font-medium">{{ siparis.musteri }}</td>
                                        <td class="font-mono font-semibold text-base">{{ siparis.urun_kodu }}</td>
                                        <td class="hidden sm:table-cell text-sm text-slate-500">{{ siparis.cinsi }} {{
                                            siparis.kalinlik }}</td>
                                        <td class="hidden sm:table-cell text-sm text-slate-500">{{
                                            siparis.siparis_tarihi }}</td>
                                        <td class="font-bold text-slate-700 text-base">{{ siparis.termin_tarihi }}</td>
                                        <td class="text-base">
                                            {% if siparis.toplam_m2 and siparis.toplam_m2 > siparis.bekleyen_m2 %}
                                            <div class="flex flex-col">
                                                <span class="font-bold text-blue-600">{{ siparis.bekleyen_m2 }}
                                                    m¬≤</span>
                                                <span class="text-[10px] text-gray-400 line-through">{{
                                                    siparis.toplam_m2 }}
                                                    m¬≤</span>
                                            </div>
                                            {% else %}
                                            <span class="font-bold text-slate-700">{{ siparis.bekleyen_m2 }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if siparis.durum == 'Bekliyor' %}
                                            <span
                                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Bekliyor</span>
                                            {% if siparis.planlanan_is_gunu > 0 %}
                                            <div class="text-xs text-orange-600 font-bold mt-1">Plan: G√ºn {{
                                                siparis.planlanan_is_gunu }}</div>
                                            {% endif %}
                                            {% else %}
                                            <span
                                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Tamamlandƒ±</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="flex gap-2">
                                                {% if siparis.durum == 'Bekliyor' %}
                                                <button data-id="{{ siparis.id }}" data-cinsi="{{ siparis.cinsi }}"
                                                    data-kalinlik="{{ siparis.kalinlik }}"
                                                    data-m2="{{ siparis.bekleyen_m2 }}"
                                                    data-kod="{{ siparis.urun_kodu }}"
                                                    data-termin="{{ siparis.termin_tarihi }}"
                                                    data-musteri="{{ siparis.musteri }}"
                                                    onclick="openEditModalFromData(this)"
                                                    class="p-2 bg-blue-100 text-blue-600 rounded hover:bg-blue-200 transition"
                                                    title="D√ºzenle">
                                                    <i class="fa-solid fa-pen"></i>
                                                </button>
                                                <button
                                                    onclick="openPartialModal({{ siparis.id }}, {{ siparis.bekleyen_m2 }}, '{{ siparis.urun_kodu }}')"
                                                    class="p-2 bg-cyan-100 text-cyan-600 rounded hover:bg-cyan-200 transition"
                                                    title="Kƒ±smi">
                                                    <i class="fa-solid fa-scissors"></i>
                                                </button>
                                                <form action="/siparis" method="POST" class="inline">
                                                    <input type="hidden" name="action" value="tamamla_siparis">
                                                    <input type="hidden" name="siparis_id" value="{{ siparis.id }}">
                                                    <button type="submit"
                                                        class="p-2 bg-green-100 text-green-600 rounded hover:bg-green-200 transition"
                                                        title="Tamamla">
                                                        <i class="fa-solid fa-check"></i>
                                                    </button>
                                                </form>
                                                {% elif siparis.durum == 'Tamamlandi' %}
                                                <button
                                                    onclick="openUndoModal({{ siparis.id }}, '{{ siparis.urun_kodu }}')"
                                                    class="p-2 bg-orange-100 text-orange-600 rounded hover:bg-orange-200 transition"
                                                    title="Geri Al">
                                                    <i class="fa-solid fa-rotate-left"></i>
                                                </button>
                                                {% endif %}
                                                <form action="/siparis" method="POST" class="inline"
                                                    onsubmit="return confirm('Silmek istediƒüinize emin misiniz?')">
                                                    <input type="hidden" name="action" value="sil_siparis">
                                                    <input type="hidden" name="siparis_id" value="{{ siparis.id }}">
                                                    <button type="submit"
                                                        class="p-2 bg-red-100 text-red-600 rounded hover:bg-red-200 transition"
                                                        title="Sil">
                                                        <i class="fa-solid fa-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>

                            <!-- MOBILE CARDS VIEW -->
                            <div class="md:hidden space-y-4">
                                {% for siparis in siparisler %}
                                <div
                                    class="bg-white rounded-xl p-4 shadow-sm border border-slate-100 relative {{ 'bg-green-50/30' if siparis.durum == 'Tamamlandi' }}">
                                    <!-- Status Badge -->
                                    <div class="absolute top-4 right-4">
                                        {% if siparis.durum == 'Bekliyor' %}
                                        <span
                                            class="inline-flex items-center px-2 py-1 rounded-md text-xs font-bold bg-yellow-100 text-yellow-800">Bekliyor</span>
                                        {% else %}
                                        <span
                                            class="inline-flex items-center px-2 py-1 rounded-md text-xs font-bold bg-green-100 text-green-800">Tamamlandƒ±</span>
                                        {% endif %}
                                    </div>
                                    <div class="pr-20">
                                        <h4 class="text-lg font-bold text-slate-900">{{ siparis.musteri }}</h4>
                                        <div class="flex items-center gap-2 mt-1">
                                            <span
                                                class="font-mono bg-slate-100 px-2 py-0.5 rounded text-xs text-slate-600 font-semibold">{{
                                                siparis.urun_kodu }}</span>
                                            <span class="text-xs text-slate-500">{{ siparis.cinsi }} {{ siparis.kalinlik
                                                }}</span>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4 mt-4 py-3 border-t border-b border-slate-50">
                                        <div>
                                            <p class="text-[10px] text-slate-400 uppercase font-semibold">Termin</p>
                                            <p class="text-sm font-medium text-slate-700">{{ siparis.termin_tarihi }}
                                            </p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-[10px] text-slate-400 uppercase font-semibold">Bekleyen</p>
                                            <p
                                                class="text-xl font-bold {{ 'text-red-500' if siparis.bekleyen_m2 > 1000 else 'text-blue-600' }}">
                                                {{ siparis.bekleyen_m2 }} m¬≤</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-between mt-4 gap-2">
                                        {% if siparis.durum == 'Bekliyor' %}
                                        <button data-id="{{ siparis.id }}" data-cinsi="{{ siparis.cinsi }}"
                                            data-kalinlik="{{ siparis.kalinlik }}" data-m2="{{ siparis.bekleyen_m2 }}"
                                            data-kod="{{ siparis.urun_kodu }}" data-termin="{{ siparis.termin_tarihi }}"
                                            data-musteri="{{ siparis.musteri }}" onclick="openEditModalFromData(this)"
                                            class="flex-1 bg-slate-100 text-slate-600 py-2 rounded-lg text-sm font-medium hover:bg-slate-200 transition">
                                            <i class="fa-solid fa-pen mr-1"></i> D√ºzenle
                                        </button>
                                        <button
                                            onclick="openPartialModal({{ siparis.id }}, {{ siparis.bekleyen_m2 }}, '{{ siparis.urun_kodu }}')"
                                            class="flex-1 bg-blue-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-blue-700 shadow-lg shadow-blue-500/30 transition">
                                            <i class="fa-solid fa-scissors mr-1"></i> Kƒ±smi
                                        </button>
                                        <form action="/siparis" method="POST" class="inline">
                                            <input type="hidden" name="action" value="tamamla_siparis">
                                            <input type="hidden" name="siparis_id" value="{{ siparis.id }}">
                                            <button type="submit"
                                                class="bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 shadow-lg shadow-green-500/30 transition"
                                                title="Tamamla">
                                                <i class="fa-solid fa-check"></i>
                                            </button>
                                        </form>
                                        {% elif siparis.durum == 'Tamamlandi' %}
                                        <button onclick="openUndoModal({{ siparis.id }}, '{{ siparis.urun_kodu }}')"
                                            class="flex-1 bg-orange-100 text-orange-600 py-2 rounded-lg text-sm font-medium hover:bg-orange-200 transition">
                                            <i class="fa-solid fa-rotate-left mr-1"></i> Geri Al
                                        </button>
                                        {% endif %}
                                        <form action="/siparis" method="POST" class="inline"
                                            onsubmit="return confirm('Silmek istediƒüinize emin misiniz?')">
                                            <input type="hidden" name="action" value="sil_siparis">
                                            <input type="hidden" name="siparis_id" value="{{ siparis.id }}">
                                            <button type="submit" class="text-red-400 hover:text-red-600 p-2 ml-1"
                                                title="Sil">
                                                <i class="fa-solid fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 7. ANALYSIS (Moved from Modal to Section) -->
                <div id="section-analysis" class="content-section hidden">
                    <div class="bg-white rounded-xl shadow-lg border border-slate-200 h-[85vh] flex flex-col">
                        <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                            <h2 class="text-xl font-bold flex items-center gap-2">
                                <i class="fa-solid fa-chart-pie text-blue-600"></i> √úr√ºn Sipari≈ü Analizi
                            </h2>
                            <div class="relative w-64">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fa-solid fa-search text-gray-400"></i>
                                </div>
                                <input type="text" id="analysisSearch"
                                    class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm uppercase"
                                    placeholder="√úr√ºn Kodu Ara..." oninput="filterAnalysis(this.value)">
                            </div>
                        </div>

                        <div class="flex flex-1 overflow-hidden p-4 gap-4">
                            <!-- Left: List -->
                            <div class="w-1/3 flex flex-col border rounded-lg overflow-hidden bg-gray-50 h-full">
                                <div
                                    class="bg-gray-100 p-2 font-bold text-xs text-gray-500 uppercase flex justify-between">
                                    <span>√úr√ºn Kodu</span>
                                    <span>Top. Bekleyen</span>
                                </div>
                                <div id="analysisList" class="flex-1 overflow-y-auto p-1 space-y-1">
                                    <!-- Populated by JS -->
                                </div>
                            </div>

                            <!-- Right: Details -->
                            <div class="w-2/3 flex flex-col border rounded-lg overflow-hidden bg-white relative h-full">
                                <div class="bg-blue-50 p-3 font-bold text-blue-800 border-b border-blue-100 flex justify-between items-center"
                                    id="analysisDetailHeader">
                                    <span>Detaylar</span>
                                    <span class="text-xs font-normal text-blue-600">√úr√ºn Se√ßiniz</span>
                                </div>
                                <div id="analysisDetailContent" class="hidden flex-1 overflow-y-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50 sticky top-0">
                                            <tr>
                                                <th
                                                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                                                    M√º≈üteri</th>
                                                <th
                                                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                                                    Tarih</th>
                                                <th
                                                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                                                    Termin</th>
                                                <th
                                                    class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">
                                                    Miktar</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="analysisDetailTableBody">
                                        </tbody>
                                    </table>
                                </div>
                                <div id="analysisEmptyState"
                                    class="flex-1 flex flex-col items-center justify-center text-gray-400">
                                    <i class="fa-solid fa-mouse-pointer text-4xl mb-2 opacity-50"></i>
                                    <p>Detaylarƒ± g√∂rmek i√ßin listeden bir √ºr√ºn se√ßin.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 8. ZEMIN ANALYSIS (Clone of Analysis) -->
                <div id="section-zemin-analysis" class="content-section hidden">
                    <div class="bg-white rounded-xl shadow-lg border border-slate-200 h-[85vh] flex flex-col">
                        <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                            <h2 class="text-xl font-bold flex items-center gap-2">
                                <i class="fa-solid fa-layer-group text-purple-600"></i> Zemin (Cins) Analizi
                            </h2>
                            <div class="relative w-64">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fa-solid fa-search text-gray-400"></i>
                                </div>
                                <input type="text" id="zeminSearch"
                                    class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-sm uppercase"
                                    placeholder="Zemin Ara..." oninput="filterZeminAnalysis(this.value)">
                            </div>
                        </div>

                        <div class="flex flex-1 overflow-hidden p-4 gap-4">
                            <!-- Left: List -->
                            <div class="w-1/3 flex flex-col border rounded-lg overflow-hidden bg-gray-50 h-full">
                                <div
                                    class="bg-gray-100 p-2 font-bold text-xs text-gray-500 uppercase flex justify-between">
                                    <span>Zemin Cinsi</span>
                                    <span>Top. Sipari≈ü</span>
                                </div>
                                <div id="zeminList" class="flex-1 overflow-y-auto p-1 space-y-1">
                                    <!-- Populated by JS -->
                                </div>
                            </div>

                            <!-- Right: Details -->
                            <div class="w-2/3 flex flex-col border rounded-lg overflow-hidden bg-white relative h-full">
                                <div class="bg-purple-50 p-3 font-bold text-purple-800 border-b border-purple-100 flex justify-between items-center"
                                    id="zeminDetailHeader">
                                    <span>Zemin Detaylarƒ±</span>
                                    <span class="text-xs font-normal text-purple-600">Zemin Se√ßiniz</span>
                                </div>
                                <div id="zeminDetailContent" class="hidden flex-1 overflow-y-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50 sticky top-0">
                                            <tr>
                                                <th
                                                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                                                    M√º≈üteri</th>
                                                <th
                                                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                                                    √úr√ºn Kodu</th>
                                                <th
                                                    class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">
                                                    Termin</th>
                                                <th
                                                    class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">
                                                    Miktar</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="zeminDetailTableBody">
                                        </tbody>
                                    </table>
                                </div>
                                <div id="zeminEmptyState"
                                    class="flex-1 flex flex-col items-center justify-center text-gray-400">
                                    <i class="fa-solid fa-layer-group text-4xl mb-2 opacity-50"></i>
                                    <p>Detaylarƒ± g√∂rmek i√ßin listeden bir zemin se√ßin.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div> <!-- END SECTIONS CONTAINER -->

    </div>
    </main>
    </div>

    <!-- MODALS -->

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog"
        aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-filter backdrop-blur-sm"
                onclick="closeModal('editModal')"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div
                class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4" id="modal-title">Sipari≈ü D√ºzenle</h3>
                    <form id="editForm" action="/siparis" method="POST" class="space-y-4">
                        <input type="hidden" name="action" value="duzenle_siparis">
                        <input type="hidden" name="siparis_id" id="edit_siparis_id">
                        <input type="hidden" name="yeni_urun_kodu_hidden" id="edit_urun_kodu_hidden">

                        <div>
                            <label class="block text-sm font-medium text-gray-700">M√º≈üteri Adƒ±</label>
                            <input type="text" name="yeni_musteri" id="edit_musteri" required
                                class="mt-1 w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Yeni M¬≤</label>
                                <input type="number" name="yeni_m2" id="edit_m2" required
                                    class="mt-1 w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Termin Tarihi</label>
                                <input type="date" name="yeni_termin_tarihi" id="edit_termin" required
                                    class="mt-1 w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>
                        </div>

                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">√úr√ºn Bilgileri</label>
                            <div class="flex gap-2">
                                <select class="cinsi_select w-1/2 border border-gray-300 rounded-md py-2 px-3 text-sm"
                                    required onchange="filterProductCodes(this)">
                                    <option value="">Cins</option>
                                    {% for c in CINSLER %}<option value="{{ c }}">{{ c }}</option>{% endfor %}
                                </select>
                                <select
                                    class="kalinlik_select w-1/2 border border-gray-300 rounded-md py-2 px-3 text-sm"
                                    required onchange="filterProductCodes(this)">
                                    <option value="">Kalƒ±nlƒ±k</option>
                                    {% for k in KALINLIKLAR %}<option value="{{ k }}">{{ k }}</option>{% endfor %}
                                </select>
                            </div>
                            <select name="yeni_urun_kodu"
                                class="urun_kodu_select w-full border border-gray-300 rounded-md py-2 px-3 text-sm"
                                required>
                                <option value="">Kod Se√ßin...</option>
                            </select>
                        </div>

                        <div class="mt-5 sm:mt-6">
                            <button type="submit"
                                class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:text-sm">
                                Deƒüi≈üiklikleri Kaydet
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Partial Modal -->
    <div id="partialModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-filter backdrop-blur-sm"
                onclick="closeModal('partialModal')"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            <div
                class="inline-block align-bottom bg-white rounded-xl px-4 pt-5 pb-4 text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-md w-full sm:p-6">
                <div>
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
                        <i class="fa-solid fa-scissors text-blue-600"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-5">
                        <h3 class="text-lg leading-6 font-bold text-gray-900">Kƒ±smi Tamamlama</h3>
                        <div class="mt-2 bg-blue-50 p-3 rounded-lg border border-blue-100">
                            <p class="text-sm text-gray-600">
                                √úr√ºn: <span id="partial_urun_info" class="font-bold text-gray-900"></span><br>
                                Bekleyen: <span id="partial_max_m2" class="font-bold text-blue-600 text-lg"></span> m¬≤
                            </p>
                        </div>

                        <!-- History Section -->
                        <div id="partial_history_container" class="mt-4 text-left hidden">
                            <h4 class="text-xs font-bold text-gray-500 uppercase border-b border-gray-200 pb-1 mb-2">
                                Ge√ßmi≈ü ƒ∞≈ülemler</h4>
                            <ul id="partial_history_list" class="text-xs space-y-2 max-h-32 overflow-y-auto pr-1">
                                <!-- History items will be injected here -->
                            </ul>
                        </div>

                        <form action="/siparis" method="POST" class="mt-4">
                            <input type="hidden" name="action" value="kismi_tamamla">
                            <input type="hidden" name="siparis_id" id="partial_siparis_id">

                            <label class="block text-left text-xs font-semibold text-gray-600 mb-1">Hazƒ±rlanan Miktar
                                (m¬≤)</label>
                            <input type="number" name="hazirlanan_m2" id="partial_input" placeholder="√ñrn: 50"
                                class="appearance-none rounded-lg relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-400 text-gray-900 focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm shadow-sm"
                                required>

                            <button type="submit"
                                class="mt-4 w-full inline-flex justify-center rounded-lg border border-transparent shadow-lg shadow-blue-500/30 px-4 py-3 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:text-sm transition-all hover:scale-[1.02]">
                                Kaydet ve D√º≈ü
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Modal -->
    <!-- Undo Modal -->
    <div id="undoModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-filter backdrop-blur-sm"
                onclick="closeModal('undoModal')"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            <div
                class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-sm w-full sm:p-6">
                <div>
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-orange-100">
                        <i class="fa-solid fa-rotate-left text-orange-600"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-5">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Sipari≈üi Geri Al</h3>
                        <p class="text-sm text-gray-500 mt-2">Bu tamamlanmƒ±≈ü bir sipari≈üi tekrar "Bekliyor" durumuna
                            getirecek.</p>

                        <form action="/siparis" method="POST" class="mt-4">
                            <input type="hidden" name="action" value="geri_al_tamamla">
                            <input type="hidden" name="siparis_id" id="undo_siparis_id">

                            <label class="block text-left text-xs font-semibold text-gray-600 mb-1">Geri Alƒ±nacak Miktar
                                (m¬≤)</label>
                            <input type="number" name="geri_alinacak_m2" min="1" placeholder="Miktar Girin"
                                class="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-orange-500 focus:border-orange-500 focus:z-10 sm:text-sm"
                                required>

                            <button type="submit"
                                class="mt-4 w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-orange-600 text-base font-medium text-white hover:bg-orange-700 sm:text-sm">
                                Sipari≈üi Kurtar
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Bulk Date Modal -->
    <div id="bulkDateModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
                onclick="document.getElementById('bulkDateModal').classList.add('hidden')"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            <div
                class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-sm w-full sm:p-6">
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Toplu Tarih G√ºncelle</h3>
                    <form id="bulkDateForm" action="/siparis" method="POST">
                        <input type="hidden" name="action" value="guncelle_tarih_toplu">
                        <div id="bulkDateInputs"></div> <!-- Hidden inputs injected here -->

                        <label class="block text-sm font-medium text-gray-700">Yeni Termin Tarihi</label>
                        <input type="date" name="yeni_termin_tarihi" required
                            class="mt-1 w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">

                        <button type="submit"
                            class="mt-4 w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:text-sm">
                            G√ºncelle
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>



    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>
    <script>
        let CINS_TO_BOYALI_MAP = {}; // Will be loaded from API
        // Use 'var' to avoid block-scope redeclaration issues if any
        var CINSLER = {{ CINSLER | tojson }};
        var KALINLIKLAR = {{ KALINLIKLAR | tojson }};

        const CINS_OPTIONS = CINSLER.map(c => `<option value="${c}">${c}</option>`).join('');
        const KALINLIK_OPTIONS = KALINLIKLAR.map(k => `<option value="${k}">${k}</option>`).join('');




        // SPA Navigation Logic
        function showSection(sectionId, linkElement) {
            console.log("Switching to section:", sectionId);

            // 1. Hide all sections
            document.querySelectorAll('.content-section').forEach(el => el.classList.add('hidden'));

            // 2. Show target section
            const target = document.getElementById(sectionId);
            if (target) {
                target.classList.remove('hidden');
            } else {
                console.error("Section not found:", sectionId);
                return;
            }

            // 3. Update Sidebar Active State
            if (linkElement) {
                document.querySelectorAll('#sidebar nav a.nav-item').forEach(el => {
                    el.classList.remove('bg-blue-600', 'text-white', 'shadow-md', 'bg-white/10');
                    el.classList.add('text-slate-300', 'hover:bg-slate-800', 'hover:text-white');
                });

                // Reset classes for the clicked element and apply active properties
                linkElement.classList.remove('text-slate-300', 'hover:bg-slate-800', 'hover:text-white');
                linkElement.classList.add('bg-blue-600', 'text-white', 'shadow-md');
            }

            // 4. Special Section Logic
            if (sectionId === 'section-analysis') {
                if (typeof loadAnalysisData === 'function') {
                    loadAnalysisData();
                } else {
                    if (typeof openAnalysisModal === 'function') openAnalysisModal();
                }
            }
            if (sectionId === 'section-zemin-analysis') {
                if (typeof loadZeminAnalysisData === 'function') loadZeminAnalysisData();
            }
        }

        // Load Product Codes from API
        async function loadProductCodes() {
            try {
                const response = await fetch('/api/urun_kodlari');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                window.productMap = await response.json();
                window.CINS_TO_BOYALI_MAP = window.productMap; // Compatibility

                // REVERSE MAP & ALL CODES
                window.reverseProductMap = {};
                window.allCodes = [];

                for (const [key, codes] of Object.entries(window.productMap)) {
                    codes.forEach(code => {
                        window.reverseProductMap[code] = key;
                        window.allCodes.push(code);
                    });
                }

                console.log("DEBUG: Product Maps Loaded. Total Codes:", window.allCodes.length);

                // Initialize UI
                const container = document.getElementById('siparis-urun-container');
                if (container && container.children.length === 0) {
                    addRow(1);
                } else {
                    // Update existing rows if any
                    document.querySelectorAll('.urun_kodu_input').forEach(input => {
                        updateDatalistWithCodes(input, window.allCodes);
                    });
                }

            } catch (error) {
                console.error("CRITICAL: Failed to load product codes", error);
                alert("√úr√ºn kodlarƒ± y√ºklenemedi! " + error.message);
            }
        }

        $(document).ready(function () {
            loadProductCodes();
        });

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('-translate-x-full');
        }

        function normalizeKey(text) {
            return text.normalize("NFC").trim().toUpperCase();
        }

        // --- ROW & PRODUCT LOGIC ---

        function updateDatalistWithCodes(input, codes) {
            const listId = input.getAttribute('list');
            const dataList = document.getElementById(listId);
            if (!dataList) return;

            // Build options string for performance
            let options = '';
            // Limit to 200 items to prevent DOM freezing if list is huge?
            // EPS codes are usually < 500, should be fine.
            codes.forEach(code => {
                options += `<option value="${code}">`;
            });
            dataList.innerHTML = options;
        }

        function filterProductCodes(selectElement) {
            const row = selectElement.closest('.siparis-satir') || selectElement.closest('div.space-y-2') || selectElement.closest('form');
            // Fallback for Modal: .space-y-2 container or form

            if (!row) return;

            const cinsi = row.querySelector('.cinsi_select').value;
            const kalinlik = row.querySelector('.kalinlik_select').value;

            const urunInput = row.querySelector('.urun_kodu_input');
            const urunSelect = row.querySelector('.urun_kodu_select');

            // IF no type/thickness, show ALL codes (Only for Input version)
            // For Select version, we might want to show empty or all. Standard behavior: Empty.

            const isInput = !!urunInput;

            if (!cinsi || !kalinlik) {
                if (isInput && window.allCodes) {
                    updateDatalistWithCodes(urunInput, window.allCodes);
                } else if (urunSelect) {
                    urunSelect.innerHTML = '<option value="">Kod Se√ßin...</option>';
                }
                return;
            }

            const key = `${cinsi} ${kalinlik}`;
            let codes = window.productMap[key];

            if (!codes) {
                // Try normalized lookup
                const normalizedKey = normalizeKey(key);
                for (const k of Object.keys(window.productMap)) {
                    if (normalizeKey(k) === normalizedKey) {
                        codes = window.productMap[k];
                        break;
                    }
                }
            }

            if (!codes) codes = [];

            if (isInput) {
                updateDatalistWithCodes(urunInput, codes);
            } else if (urunSelect) {
                urunSelect.innerHTML = '<option value="">Kod Se√ßin...</option>';
                codes.forEach(code => {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = code;
                    urunSelect.appendChild(option);
                });

                // If there's a data-value (edit modal), try to re-select it
                const savedVal = urunSelect.getAttribute('data-value');
                if (savedVal) urunSelect.value = savedVal;
            }
        }

        function handleCodeInput(input) {
            const code = input.value.trim().toUpperCase();

            // Check Reverse Map
            const key = window.reverseProductMap ? window.reverseProductMap[code] : null;

            if (key) {
                // Match found: Auto-select Cins & Kalinlik
                const row = input.closest('.siparis-satir');
                const cinsiSelect = row.querySelector('.cinsi_select');
                const kalinlikSelect = row.querySelector('.kalinlik_select');

                // Strategy: Find Kalinlik by suffix matching options
                let foundKalinlik = null;
                for (let opt of kalinlikSelect.options) {
                    if (opt.value && key.endsWith(opt.value)) {
                        foundKalinlik = opt.value;
                        break;
                    }
                }

                if (foundKalinlik) {
                    const foundCinsi = key.substring(0, key.length - foundKalinlik.length).trim();

                    // Verify Cins exists
                    let cinsiExists = false;
                    for (let opt of cinsiSelect.options) {
                        if (opt.value === foundCinsi) { cinsiExists = true; break; }
                    }

                    if (cinsiExists) {
                        // Apply Values
                        cinsiSelect.value = foundCinsi;
                        kalinlikSelect.value = foundKalinlik;

                        // Update List (Filter)
                        filterProductCodes(cinsiSelect);

                        // Visual Feedback
                        input.classList.remove('border-slate-300');
                        input.classList.add('border-green-500', 'bg-green-50');
                        setTimeout(() => input.classList.remove('border-green-500', 'bg-green-50', 'border-slate-300'), 1500);
                    }
                }
            }
        }

        let rowIndex = 0;
        function addRow(count = 1) {
            const container = document.getElementById('siparis-urun-container');
            for (let i = 0; i < count; i++) {
                rowIndex++;
                const html = `
                    <div class="siparis-satir flex gap-2 items-center bg-slate-50 p-2 rounded border border-slate-200" id="row-${rowIndex}">
                        <select name="urun_kodu_compat_${rowIndex}" class="hidden"></select> <!-- Backend Compat (Renamed to avoid conflict) -->
                        
                        <div class="flex-1 grid grid-cols-2 gap-2">
                             <select class="cinsi_select w-full text-sm rounded border-slate-300 py-2" name="cinsi_${rowIndex}" required onchange="filterProductCodes(this)">
                                <option value="">Cins</option>
                                ${CINS_OPTIONS}
                             </select>
                             <select class="kalinlik_select w-full text-sm rounded border-slate-300 py-2" name="kalinlik_${rowIndex}" required onchange="filterProductCodes(this)">
                                <option value="">Kalƒ±nlƒ±k</option>
                                ${KALINLIK_OPTIONS}
                             </select>
                        </div>
                        <div class="w-1/4 relative">
                             <input type="text" 
                                    name="urun_kodu_${rowIndex}" 
                                    class="urun_kodu_input w-full text-sm rounded border-slate-300 uppercase font-mono py-2" 
                                    required 
                                    placeholder="Kod (Yaz/Se√ß)" 
                                    list="list_urun_kodu_${rowIndex}"
                                    oninput="handleCodeInput(this)"
                                    autocomplete="off">
                             <datalist id="list_urun_kodu_${rowIndex}"></datalist>
                        </div>
                        <div class="w-1/5">
                             <input type="number" name="m2_${rowIndex}" placeholder="M¬≤" required class="w-full text-sm rounded border-slate-300 py-2">
                        </div>
                        <button type="button" onclick="document.getElementById('row-${rowIndex}').remove()" class="text-red-500 hover:text-red-700 px-2">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);

                // Populate default list
                const input = document.getElementById(`row-${rowIndex}`).querySelector('.urun_kodu_input');
                if (window.allCodes) updateDatalistWithCodes(input, window.allCodes);
            }
        }



        // Modal Functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function openEditModal(id, cinsi, kalinlik, m2, urun_kodu, termin, musteri) {
            const modal = document.getElementById('editModal');
            modal.classList.remove('hidden');

            document.getElementById('edit_siparis_id').value = id;
            document.getElementById('edit_m2').value = m2;
            document.getElementById('edit_termin').value = termin;
            document.getElementById('edit_musteri').value = musteri;
            document.getElementById('edit_urun_kodu_hidden').value = urun_kodu;

            const form = document.getElementById('editForm');
            const cinsiSelect = form.querySelector('.cinsi_select');
            const kalinlikSelect = form.querySelector('.kalinlik_select');
            const urunSelect = form.querySelector('.urun_kodu_select');

            cinsiSelect.value = cinsi.toUpperCase(); // Ensure uppercase for select matching
            kalinlikSelect.value = kalinlik.toUpperCase();

            // Set value efficiently to trigger filter
            urunSelect.setAttribute('data-value', urun_kodu);
            filterProductCodes(cinsiSelect);
            urunSelect.value = urun_kodu;
        }

        function openEditModalFromData(button) {
            const id = button.getAttribute('data-id');
            const cinsi = button.getAttribute('data-cinsi');
            const kalinlik = button.getAttribute('data-kalinlik');
            const m2 = button.getAttribute('data-m2');
            const urun_kodu = button.getAttribute('data-kod');
            const termin = button.getAttribute('data-termin');
            const musteri = button.getAttribute('data-musteri');

            openEditModal(id, cinsi, kalinlik, m2, urun_kodu, termin, musteri);
        }

        async function openPartialModal(id, currentM2, code) {
            document.getElementById('partialModal').classList.remove('hidden');
            document.getElementById('partial_siparis_id').value = id;
            document.getElementById('partial_max_m2').innerText = currentM2;
            document.getElementById('partial_urun_info').innerText = code;
            document.getElementById('partial_input').max = currentM2;
            document.getElementById('partial_input').value = ''; // Reset input

            // Fetch History
            const historyContainer = document.getElementById('partial_history_container');
            const historyList = document.getElementById('partial_history_list');
            try {
                const response = await fetch(`/api/siparis_gecmisi/${id}`);
                const history = await response.json();

                historyList.innerHTML = '';
                if (history && history.length > 0) {
                    historyContainer.classList.remove('hidden');
                    history.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-100';
                        li.innerHTML = `
                            <span>
                                <span class="font-bold text-gray-700">${item.miktar} m¬≤</span> 
                                <span class="text-gray-400 text-[10px] ml-1">${item.tarih}</span>
                            </span>
                            <form action="/siparis" method="POST" class="inline" onsubmit="return confirm('Bu i≈ülemi geri almak istiyor musunuz? Bekleyen miktara eklenecektir.')">
                                <input type="hidden" name="action" value="geri_al_kismi">
                                <input type="hidden" name="gecmis_id" value="${item.id}">
                                <button type="submit" class="text-xs text-orange-500 hover:text-orange-700 font-medium px-2 py-1 rounded hover:bg-orange-50 transition">
                                    <i class="fa-solid fa-rotate-left"></i> Geri Al
                                </button>
                            </form>
                        `;
                        historyList.appendChild(li);
                    });
                } else {
                    historyContainer.classList.add('hidden');
                }
            } catch (e) {
                console.error("Ge√ßmi≈ü y√ºklenemedi", e);
                historyContainer.classList.add('hidden');
            }
        }

        function openUndoModal(id, code) {
            document.getElementById('undoModal').classList.remove('hidden');
            document.getElementById('undo_siparis_id').value = id;
        }

        // Create global state for analysis
        window.analysisData = [];

        async function loadAnalysisData() {
            // Visibility is handled by showSection('section-analysis') calling this.
            const listContainer = document.getElementById('analysisList');
            const searchInput = document.getElementById('analysisSearch');

            searchInput.value = '';
            searchInput.focus();

            // Reset Right Side
            document.getElementById('analysisDetailContent').classList.add('hidden');
            document.getElementById('analysisEmptyState').classList.remove('hidden');
            document.getElementById('analysisDetailHeader').innerHTML = `<span>Detaylar</span><span class="text-xs font-normal text-blue-600">√úr√ºn Se√ßiniz</span>`;

            // Loading State
            listContainer.innerHTML = '<div class="p-4 text-center text-gray-400"><i class="fa-solid fa-spinner fa-spin"></i> Y√ºkleniyor...</div>';

            try {
                const response = await fetch('/api/siparis_analizi');
                if (!response.ok) throw new Error("API Hatasƒ±");
                window.analysisData = await response.json();

                console.log("Analysis Data Loaded:", window.analysisData); // Debug info for user

                renderAnalysis(window.analysisData);

            } catch (e) {
                console.error(e);
                listContainer.innerHTML = '<div class="p-4 text-center text-red-500">Veri y√ºklenemedi.</div>';
            }
        }

        function renderAnalysis(data) {
            const listContainer = document.getElementById('analysisList');
            listContainer.innerHTML = '';

            if (data.length === 0) {
                listContainer.innerHTML = '<div class="p-4 text-center text-gray-400 text-sm">Bekleyen sipari≈ü yok.</div>';
                return;
            }

            data.forEach(item => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-white p-3 rounded border border-gray-200 hover:bg-blue-50 cursor-pointer transition select-none group";
                div.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-bold text-gray-700 text-base">${item.urun_kodu}</span>
                        ${item.aciklama ? `<span class="text-xs text-gray-400 font-normal">(${item.aciklama})</span>` : ''}
                    </div>
                    <div class="text-base font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded group-hover:bg-blue-100">${item.toplam_bekleyen.toLocaleString('tr-TR')} m¬≤</div>
                `;
                // Pass OBJECT, not ID (to handle duplicates like "BOYASIZ")
                div.onclick = () => showAnalysisDetail(item);
                listContainer.appendChild(div);
            });
        }

        function filterAnalysis(query) {
            query = query.trim().toUpperCase();

            // 1. Filter List
            const filtered = window.analysisData.filter(item => {
                const searchStr = (item.urun_kodu + " " + (item.aciklama || "")).toUpperCase();
                return searchStr.includes(query);
            });
            renderAnalysis(filtered);

            // 2. Auto-Select if perfect match on CODE
            const exactMatch = window.analysisData.find(item => item.urun_kodu === query);

            if (exactMatch) {
                showAnalysisDetail(exactMatch);
            }
        }

        function showAnalysisDetail(param) {
            let item;
            if (typeof param === 'string') {
                // Fallback for string ID (picks first match)
                item = window.analysisData.find(x => x.urun_kodu === param);
            } else {
                // Object reference (Preferred)
                item = param;
            }

            if (!item) return;
            if (!item) return;

            // Update Header
            const header = document.getElementById('analysisDetailHeader');
            header.innerHTML = `
                <span class="flex items-center gap-2"><i class="fa-solid fa-box text-blue-500"></i> ${item.urun_kodu}</span>
                <span class="text-lg font-bold text-blue-700">${item.toplam_bekleyen.toLocaleString('tr-TR')} m¬≤</span>
            `;

            // Show Content
            document.getElementById('analysisEmptyState').classList.add('hidden');
            document.getElementById('analysisDetailContent').classList.remove('hidden');

            const tbody = document.getElementById('analysisDetailTableBody');
            tbody.innerHTML = '';

            // Sort details by Termin (closest first)
            const details = [...item.detaylar].sort((a, b) => new Date(a.termin_tarihi) - new Date(b.termin_tarihi));

            details.forEach(d => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition";
                tr.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${d.musteri}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${d.siparis_tarihi}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            ${d.termin_tarihi}
                        </span>
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900 text-right font-bold">${d.bekleyen_m2.toLocaleString('tr-TR')}</td>
                `;
                tbody.appendChild(tr);
            });
        }



        // --- ZEMIN ANALYSIS LOGIC ---
        window.zeminData = [];

        async function loadZeminAnalysisData() {
            // Re-use the SAME API output but process it differently
            const listContainer = document.getElementById('zeminList');
            const searchInput = document.getElementById('zeminSearch');

            searchInput.value = '';

            // Reset Right Side
            document.getElementById('zeminDetailContent').classList.add('hidden');
            document.getElementById('zeminEmptyState').classList.remove('hidden');
            document.getElementById('zeminDetailHeader').innerHTML = `<span>Zemin Detaylarƒ±</span><span class="text-xs font-normal text-purple-600">Zemin Se√ßiniz</span>`;

            // Loading State
            listContainer.innerHTML = '<div class="p-4 text-center text-gray-400"><i class="fa-solid fa-spinner fa-spin"></i> Y√ºkleniyor...</div>';

            try {
                // Check if we already have data from analysis? Better fetch fresh to be safe.
                const response = await fetch('/api/siparis_analizi');
                if (!response.ok) throw new Error("API Hatasƒ±");
                const rawData = await response.json();

                // GROUP BY 'CINSI' (e.g. KARBONLU, BEYAZ) logic
                // The API returns distinct Items (Key: Code+Cins+Kalinlik)
                // We need to aggregate by item.cinsi (extracted from item details or parsed) - actually our API returns 'aciklama' like "CINSI KALINLIK"
                // But wait, the API returns objects like {urun_kodu, aciklama, ... details: [{cinsi, kalinlik...}]}
                // Actually the API structure is: {urun_kodu, aciklama, toplam_bekleyen, detaylar: [{...}]}

                // Problem: 'cinsi' is inside detail items. Let's look at API again.
                // API source: `aciklama = f"{cinsi} {kalinlik}"`
                // We can parse 'aciklama' OR better yet, check the first detail item since they are grouped by Cins/Kalinlik anyway.

                const grouped = {};

                rawData.forEach(item => {
                    // Extract Cins from the first detail (assuming consistency)
                    // If no details, skip
                    if (!item.detaylar || item.detaylar.length === 0) return;

                    // We need 'Cinsi' solely.
                    // Let's assume the API doesn't send 'cinsi' in top level.
                    // We can try to parse 'aciklama' but it's risky if format changes.
                    // Ideally API should send 'cinsi'.
                    // However, we can infer it. Aciklama: "KARBONLU 1.5 CM" -> Cins: "KARBONLU"

                    let cinsi = "Dƒ∞ƒûER";
                    if (item.aciklama) {
                        const parts = item.aciklama.split(' ');
                        if (parts.length > 0) cinsi = parts[0];
                    }

                    if (!grouped[cinsi]) {
                        grouped[cinsi] = {
                            name: cinsi,
                            total_orders: 0,
                            items: []
                        };
                    }

                    // Add this item's pending count (as it represents order volume in m2, user asked for "sort by number of orders"? 
                    // "List floor types sorted by the number of orders" -> Request says "Number of orders". 
                    // Interpreted as "Count of Rows" not "Volume M2".

                    // Calculate Order Count (Rows)
                    const orderCount = item.detaylar.length;
                    grouped[cinsi].total_orders += orderCount;

                    // Add all details to this group for the view
                    item.detaylar.forEach(d => {
                        grouped[cinsi].items.push({
                            ...d,
                            urun_kodu: item.urun_kodu
                        });
                    });
                });

                // Convert to array
                window.zeminData = Object.values(grouped);

                // Sort by Number of Orders (Desc)
                window.zeminData.sort((a, b) => b.total_orders - a.total_orders);

                renderZeminList(window.zeminData);

            } catch (e) {
                console.error(e);
                listContainer.innerHTML = '<div class="p-4 text-center text-red-500">Veri y√ºklenemedi.</div>';
            }
        }

        function renderZeminList(data) {
            const listContainer = document.getElementById('zeminList');
            listContainer.innerHTML = '';

            if (data.length === 0) {
                listContainer.innerHTML = '<div class="p-4 text-center text-gray-400 text-sm">Veri yok.</div>';
                return;
            }

            data.forEach(group => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-white p-3 rounded border border-gray-200 hover:bg-purple-50 cursor-pointer transition select-none group";
                div.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-bold text-gray-700 text-base">${group.name}</span>
                        <span class="text-xs text-gray-400 font-normal">Toplam ${group.total_orders} Sipari≈ü Satƒ±rƒ±</span>
                    </div>
                    <div class="text-base font-bold text-purple-600 bg-purple-50 px-2 py-1 rounded group-hover:bg-purple-100">
                        <i class="fa-solid fa-chevron-right text-xs"></i>
                    </div>
                `;
                div.onclick = () => showZeminDetail(group);
                listContainer.appendChild(div);
            });
        }

        function filterZeminAnalysis(query) {
            query = query.trim().toUpperCase();
            const filtered = window.zeminData.filter(g => g.name.includes(query));
            renderZeminList(filtered);
        }

        function showZeminDetail(group) {
            // Update Header
            const header = document.getElementById('zeminDetailHeader');
            header.innerHTML = `
                <span class="flex items-center gap-2"><i class="fa-solid fa-layer-group text-purple-500"></i> ${group.name}</span>
                <span class="text-xs font-bold text-purple-700 bg-purple-100 px-2 py-1 rounded">${group.total_orders} Kayƒ±t</span>
            `;

            // Show Content
            document.getElementById('zeminEmptyState').classList.add('hidden');
            document.getElementById('zeminDetailContent').classList.remove('hidden');

            const tbody = document.getElementById('zeminDetailTableBody');
            tbody.innerHTML = '';

            // Sort by Termination Date (Closest First)
            const sortedItems = [...group.items].sort((a, b) => new Date(a.termin_tarihi) - new Date(b.termin_tarihi));

            sortedItems.forEach(d => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition";
                tr.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${d.musteri}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm font-mono text-gray-600">${d.urun_kodu}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            ${d.termin_tarihi}
                        </span>
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900 text-right font-bold">${d.bekleyen_m2.toLocaleString('tr-TR')}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- BULK ACTION LOGIC ---
        function toggleAllCheckboxes(source) {
            const checkboxes = document.querySelectorAll('.order-checkbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
            updateBulkToolbar();
        }

        function updateBulkToolbar() {
            const selected = document.querySelectorAll('.order-checkbox:checked');
            const toolbar = document.getElementById('bulkActionToolbar');
            const countSpan = document.getElementById('selectedCount');

            countSpan.innerText = selected.length;

            if (selected.length > 0) {
                toolbar.classList.remove('hidden');
            } else {
                toolbar.classList.add('hidden');
            }
        }

        function getSelectedIds() {
            return Array.from(document.querySelectorAll('.order-checkbox:checked')).map(cb => cb.value);
        }

        function submitBulkAction(actionType) {
            const ids = getSelectedIds();
            if (ids.length === 0) return;

            let confirmMsg = "Se√ßili sipari≈üler √ºzerinde i≈ülem yapmak istediƒüinize emin misiniz?";
            if (actionType === 'sil_toplu') confirmMsg = "UYARI: Se√ßili sipari≈üler KALICI OLARAK Silinecek! Emin misiniz?";
            if (actionType === 'tamamla_toplu') confirmMsg = "Se√ßili sipari≈üler TAMAMLANDI olarak i≈üaretlenecek.";

            if (!confirm(confirmMsg)) return;

            // Create a form dynamically and submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/siparis';

            const actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            actionInput.value = actionType;
            form.appendChild(actionInput);

            ids.forEach(id => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'siparis_ids[]';
                input.value = id;
                form.appendChild(input);
            });

            document.body.appendChild(form);
            form.submit();
        }

        function openBulkDateModal() {
            const ids = getSelectedIds();
            if (ids.length === 0) return;

            const container = document.getElementById('bulkDateInputs');
            container.innerHTML = '';
            ids.forEach(id => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'siparis_ids[]';
                input.value = id;
                container.appendChild(input);
            });

            document.getElementById('bulkDateModal').classList.remove('hidden');
        }

        // Global Error Handler
        window.onerror = function (msg, url, line, col, error) {
            const debugEl = document.getElementById('debug-api-status');
            if (debugEl) debugEl.innerHTML = `JS ERROR: ${msg} (Line ${line})`;
            console.error("Global Error:", msg, error);
            return false;
        };

        // Init DataTables and Defaults
        $(document).ready(function () {
            try {
                $('#ordersTable').DataTable({
                    responsive: true,
                    language: { url: "//cdn.datatables.net/plug-ins/1.11.5/i18n/tr.json" },
                    pageLength: 25,
                    order: [[5, "asc"]] // Sort by Termin Tarihi (Index 5 now)
                });

                // Init SPA: Activate first visible section or default
                console.log("Initializing SPA...");
                const activeLink = document.querySelector('#sidebar nav a.bg-blue-600');
                if (activeLink) {
                    // If one is hardcoded active in HTML, use it
                    const onclickVal = activeLink.getAttribute('onclick'); // "showSection('...')"
                    if (onclickVal) {
                        // execute it to ensure state is correct
                        // We can't eval easily, but we can trust the click
                        activeLink.click();
                    }
                } else {
                    // Default to Dashboard or Pending Orders
                    // Let's try to click the "Bekleyen Sipari≈üler" as it was default in the html snippet I saw
                    const defaultLink = document.querySelector("a[onclick*='section-pending-orders']");
                    if (defaultLink) showSection('section-pending-orders', defaultLink);
                }

                console.log("DEBUG: Frontend Script Initialized Successfully");
            } catch (e) {
                console.error("Init Error:", e);
                alert("Ba≈ülatma Hatasƒ±: " + e.message);
            }
        });
    </script>
</body>

</html>