<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobil √úretim | EPS v3</title>

    <style>
        /* --- DARK MODE STƒ∞L --- */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 15px;
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .container {
            max-width: 650px;
            margin: auto;
            background: #1e293b;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid #334155;
        }

        h1 {
            color: #60a5fa;
            font-size: 1.5em;
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 2px solid #334155;
            padding-bottom: 12px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        h2 {
            font-size: 1.0em;
            font-weight: 600;
            margin: 0;
        }

        /* --- ACCORDION (A√ßƒ±lƒ±r/Kapanƒ±r) --- */
        .accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background-color: #334155;
            border: 1px solid #475569;
            border-radius: 12px;
            margin-top: 15px;
            cursor: pointer;
            color: #f8fafc;
            transition: all 0.2s;
        }

        .accordion-header:hover {
            background-color: #475569;
        }

        .accordion-header.active {
            background-color: #2563eb;
            border-color: #2563eb;
        }

        .accordion-icon {
            font-size: 0.9em;
            transition: transform 0.3s;
            opacity: 0.7;
        }

        .accordion-header.active .accordion-icon {
            transform: rotate(180deg);
            opacity: 1;
        }

        .accordion-content {
            background-color: #1e293b;
            padding: 0 15px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s;
            border-left: 1px solid #334155;
            border-right: 1px solid #334155;
        }

        .accordion-content.open {
            max-height: 5000px;
            padding: 15px;
            border-bottom: 1px solid #334155;
            border-radius: 0 0 12px 12px;
        }

        /* Tablo Stilleri */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 10px;
            font-size: 0.85em;
            color: #cbd5e1;
        }

        th,
        td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid #334155;
        }

        th {
            background-color: #0f172a;
            color: #94a3b8;
            font-weight: 600;
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .count-cell {
            font-weight: bold;
            color: #f8fafc;
            font-family: 'Roboto Mono', monospace;
        }

        /* Durum Badge */
        .status-bekliyor {
            background-color: rgba(234, 179, 8, 0.2);
            color: #facc15;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8em;
            border: 1px solid rgba(234, 179, 8, 0.3);
        }

        .status-tamamlandi {
            background-color: rgba(34, 197, 94, 0.2);
            color: #4ade80;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8em;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .deficit-red {
            color: #f87171;
            font-weight: bold;
        }

        .production-blue {
            color: #60a5fa;
            font-style: italic;
            font-size: 0.9em;
        }

        .loading,
        .error {
            text-align: center;
            padding: 30px;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .loading {
            color: #94a3b8;
            font-style: italic;
        }

        .error {
            background-color: rgba(239, 68, 68, 0.1);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* Plan Kartlarƒ± */
        .plan-box {
            background: #0f172a;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #334155;
            margin-bottom: 16px;
        }

        .plan-box h3 {
            color: #94a3b8;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Customer Group Styles (Yeni) */
        .customer-group {
            background-color: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
        }

        .customer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .customer-name {
            font-size: 0.85em;
            font-weight: 700;
            color: #e2e8f0;
        }

        .customer-total {
            font-size: 0.75em;
            font-weight: 600;
            background-color: #334155;
            color: #94a3b8;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .product-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .product-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            padding: 4px 0;
            border-top: 1px dashed #334155;
        }

        .product-code {
            color: #94a3b8;
            font-family: monospace;
        }

        .product-m2 {
            color: #f8fafc;
            font-weight: 600;
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Buton */
        #refreshButton {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            font-size: 0.9em !important;
            transition: transform 0.2s, opacity 0.2s;
        }

        #refreshButton:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .no-data {
            text-align: center;
            color: #94a3b8;
            font-size: 0.85em;
            padding: 15px;
            border: 1px dashed #334155;
            border-radius: 8px;
        }
    </style>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono:wght@500&display=swap"
        rel="stylesheet">
</head>

<body>
    <div class="container">
        <h1>üì± Mobil √úretim Paneli</h1>

        <button id="refreshButton" onclick="fetchData()"
            style="margin-bottom: 20px; color: white; padding: 14px 15px; border: none; border-radius: 10px; width: 100%; cursor: pointer;">
            üîÑ Verileri Yenile
        </button>

        <div id="plan-ozeti-header" class="accordion-header" onclick="toggleAccordion('plan-ozeti-content')">
            <h2>üöÄ √úretim ve Sevkiyat</h2>
            <span class="accordion-icon">‚ñº</span>
        </div>
        <div id="plan-ozeti-content" class="accordion-content">
            <div id="plan-ozeti">
                <div class="loading">Veriler y√ºkleniyor...</div>
            </div>
        </div>

        <div id="stok-tablosu-header" class="accordion-header" onclick="toggleAccordion('stok-tablosu-content')">
            <h2>üì¶ Stok Durumu</h2>
            <span class="accordion-icon">‚ñº</span>
        </div>
        <div id="stok-tablosu-content" class="accordion-content">
            <div class="table-responsive">
                <div id="stok-tablosu">
                    <div class="loading">Stok verileri...</div>
                </div>
            </div>
        </div>

        <div id="siparis-listesi-header" class="accordion-header" onclick="toggleAccordion('siparis-listesi-content')">
            <h2>üìã Sipari≈ü Listesi</h2>
            <span class="accordion-icon">‚ñº</span>
        </div>
        <div id="siparis-listesi-content" class="accordion-content">
            <div class="table-responsive">
                <div id="siparis-listesi">
                    <div class="loading">Sipari≈ü verileri...</div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const API_URL = "/api/stok";
        const refreshButton = document.getElementById('refreshButton');

        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            toggleAccordion('plan-ozeti-content');
        });

        function toggleAccordion(contentId) {
            const content = document.getElementById(contentId);
            const header = content.previousElementSibling;
            content.classList.toggle('open');
            header.classList.toggle('active');
        }

        function formatM2(m2) {
            if (m2 === null || m2 === undefined) return '0';
            return parseFloat(m2).toLocaleString('tr-TR', { maximumFractionDigits: 0 });
        }

        async function fetchData() {
            refreshButton.disabled = true;
            refreshButton.innerHTML = '‚è≥ Y√ºkleniyor...';

            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
                const data = await response.json();

                renderPlanlama(data.toplam_gerekli_siva, data.gunluk_siva_m2, data.siva_plan_detay, data.sevkiyat_plan_detay);
                renderStok(data.stok, data.deficit_analysis);
                renderSiparisler(data.siparisler);

                refreshButton.innerHTML = '‚úÖ G√ºncel';
                setTimeout(() => refreshButton.innerHTML = 'üîÑ Verileri Yenile', 2000);

            } catch (error) {
                console.error("Fetch Error:", error);
                document.getElementById('plan-ozeti').innerHTML = `<div class="error">Baƒülantƒ± Hatasƒ±: ${error.message}</div>`;
                refreshButton.innerHTML = '‚ö†Ô∏è Hata Olu≈ütu';
            } finally {
                refreshButton.disabled = false;
            }
        }

        function renderPlanlama(toplam_eksi_m2, kapasite, sivaPlan, sevkiyatPlan) {
            let html = `
                <div style="margin: 15px 0; padding: 10px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.2); display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #60a5fa; font-weight: 600; font-size: 0.9em;">Kapasite</span>
                    <span style="color: #f8fafc; font-weight: 700;">${formatM2(kapasite)} m¬≤/g√ºn</span>
                </div>`;

            // 1. SIVA PLANI
            html += `<div class="plan-box"><h3>üß± Sƒ±va Planƒ±</h3>`;
            const sivaKeys = Object.keys(sivaPlan).sort((a, b) => parseInt(a) - parseInt(b));

            if (sivaKeys.length > 0) {
                sivaKeys.forEach(gun => {
                    const gunlukUretim = Array.isArray(sivaPlan[gun]) ? sivaPlan[gun] : Object.values(sivaPlan[gun]);
                    const toplamM2 = gunlukUretim.reduce((sum, item) => sum + item.m2, 0);

                    html += `<div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #334155; padding-bottom: 4px; margin-bottom: 4px;">
                            <span style="color: #94a3b8; font-size: 0.85em; font-weight: 600;">G√ºn ${gun}</span>
                            <span style="color: #60a5fa; font-weight: 700; font-size: 0.85em;">${formatM2(toplamM2)} m¬≤</span>
                        </div>
                        <ul class="product-list">`;
                    gunlukUretim.forEach(item => {
                        html += `<li class="product-item">
                                <span style="color: #cbd5e1;">${item.cinsi}</span>
                                <span class="product-m2">${formatM2(item.m2)}</span>
                            </li>`;
                    });
                    html += `</ul></div>`;
                });
            } else {
                html += `<div class="no-data">√úretim ihtiyacƒ± yok.</div>`;
            }
            html += `</div>`;

            // 2. SEVKƒ∞YAT PLANI (YENƒ∞ FORMAT: Date -> Customer -> Items)
            html += `<div class="plan-box" style="border-color: rgba(245, 158, 11, 0.3);">
                    <h3 style="color: #fbbf24;">üöö Sevkiyat Planƒ±</h3>`;

            const sevkiyatKeys = Object.keys(sevkiyatPlan).sort();

            if (sevkiyatKeys.length > 0) {
                sevkiyatKeys.forEach(tarih => {
                    const musteriler = sevkiyatPlan[tarih];
                    let gunlukToplam = 0;
                    Object.values(musteriler).forEach(urunListesi => {
                        gunlukToplam += urunListesi.reduce((sum, i) => sum + i.bekleyen_m2, 0);
                    });

                    html += `<div style="margin-top: 15px;">
                                <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                                    <span style="background: #fbbf24; color: #1e293b; font-weight: bold; font-size: 0.75em; padding: 2px 6px; border-radius: 4px;">${tarih}</span>
                                    <span style="color: #94a3b8; font-size: 0.8em;">Toplam: ${formatM2(gunlukToplam)} m¬≤</span>
                                </div>
                                <div style="padding-left: 5px; border-left: 2px solid #334155;">`;

                    for (const [musteri, urunler] of Object.entries(musteriler)) {
                        const musteriToplam = urunler.reduce((sum, i) => sum + i.bekleyen_m2, 0);
                        html += `<div class="customer-group">
                                    <div class="customer-header">
                                        <span class="customer-name">${musteri}</span>
                                        <span class="customer-total">${formatM2(musteriToplam)} m¬≤</span>
                                    </div>
                                    <ul class="product-list">`;
                        urunler.forEach(item => {
                            html += `<li class="product-item">
                                        <span class="product-code">${item.urun_kodu}</span>
                                        <span class="product-m2">${formatM2(item.bekleyen_m2)}</span>
                                     </li>`;
                        });
                        html += `   </ul>
                                 </div>`;
                    }
                    html += `   </div>
                             </div>`;
                });
            } else {
                html += `<div class="no-data">Planlanan sevkiyat yok.</div>`;
            }
            html += `</div>`;

            document.getElementById('plan-ozeti').innerHTML = html;
        }

        function renderStok(stokData, deficitAnalysis) {
            let html = '<table><tr><th>√úr√ºn (Cins/Boyut)</th><th>Stok</th><th>Eksik</th></tr>';
            const sortedKeys = Object.keys(stokData).sort();
            let hasData = false;

            sortedKeys.forEach(key => {
                const value = stokData[key];
                const itemKey = key.substring(0, key.lastIndexOf(' (')).trim();
                const asama = key.substring(key.lastIndexOf('(') + 1, key.lastIndexOf(')'));
                const deficitInfo = deficitAnalysis[itemKey];
                let deficitHTML = '';

                if (deficitInfo && asama === 'Sivali' && deficitInfo.sivali_deficit > 0) {
                    deficitHTML = `<span class="deficit-red">-${formatM2(deficitInfo.sivali_deficit)}</span>`;
                } else if (deficitInfo && asama === 'Ham' && deficitInfo.ham_deficit > 0) {
                    deficitHTML = `<span class="deficit-red">-${formatM2(deficitInfo.ham_deficit)}</span>`;
                }

                if (value !== 0 || deficitHTML !== '') {
                    hasData = true;
                    // Ham / Sƒ±valƒ± ayrƒ±mƒ±
                    const rowStyle = asama === 'Ham' ? 'color: #94a3b8;' : 'color: #e2e8f0; font-weight: 500;';
                    html += `<tr style="${rowStyle}">
                        <td>${key.replace(' (Sivali)', '').replace(' (Ham)', '')} <span style="font-size:0.7em; opacity:0.6; border:1px solid #475569; padding: 0 4px; border-radius: 3px;">${asama}</span></td>
                        <td class="count-cell">${formatM2(value)}</td>
                        <td>${deficitHTML}</td>
                    </tr>`;
                }
            });
            html += '</table>';

            if (!hasData) html = '<div class="no-data">Stok kaydƒ± bulunamadƒ±.</div>';

            document.getElementById('stok-tablosu').innerHTML = html;
        }

        function renderSiparisler(siparisler) {
            let html = '<table><tr><th>M√º≈üteri</th><th style="text-align:right">M¬≤</th><th>Tarih/Durum</th></tr>';

            if (siparisler.length === 0) {
                html = '<div class="no-data">Sipari≈ü bulunmuyor.</div>';
            } else {
                siparisler.forEach(s => {
                    let statusClass = s.durum === 'Bekliyor' ? 'status-bekliyor' : 'status-tamamlandi';
                    let rowOpacity = s.durum === 'Tamamlandi' ? '0.6' : '1';
                    html += `<tr style="opacity: ${rowOpacity}">
                        <td>
                            <div style="font-weight: 600; color: #f8fafc;">${s.musteri}</div>
                            <div style="font-size: 0.8em; color: #94a3b8; font-family:monospace;">${s.urun_kodu}</div>
                        </td>
                        <td style="text-align:right; font-weight:bold; color: #f8fafc;">
                            ${formatM2(s.bekleyen_m2)}
                        </td>
                        <td>
                            <div style="font-size: 0.8em; margin-bottom: 2px;">${s.termin_tarihi}</div>
                            <span class="${statusClass}">${s.durum}</span>
                        </td>
                    </tr>`;
                });
                html += '</table>';
            }
            document.getElementById('siparis-listesi').innerHTML = html;
        }
    </script>
</body>

</html>