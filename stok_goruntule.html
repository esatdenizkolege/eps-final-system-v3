<script>
        // CRITICAL FIX: URL ayrıştırma hatasını gidermek için göreceli yol yerine 
        // tarayıcının ana adresini (window.location.origin) kullanıyoruz. Bu, hata veren kodu düzeltir.
        const API_URL = window.location.origin + "/api/stok";

        document.addEventListener('DOMContentLoaded', fetchData);

        async function fetchData() {
            document.getElementById('stok-tablosu').innerHTML = '<div class="loading">Veriler çekiliyor...</div>';
            document.getElementById('siparis-listesi').innerHTML = '<div class="loading">Siparişler çekiliyor...</div>';
            
            try {
                const response = await fetch(API_URL);
                
                if (!response.ok) {
                    throw new Error(`API erişim hatası: HTTP ${response.status}`);
                }
                const data = await response.json();
                
                // API'den gelen veriler: "stok", "siparisler" (tüm siparişler) ve "deficit_analysis"
                renderStok(data.stok, data.deficit_analysis); 
                renderSiparisler(data.siparisler);

            } catch (error) {
                // Hata detayını konsola yazdır, kullanıcıya genel bir bağlantı hatası göster.
                console.error("Fetch Error:", error); 
                document.getElementById('stok-tablosu').innerHTML = `<div class="error">Bağlantı Hatası: API'ye ulaşılamıyor.</div>`;
                document.getElementById('siparis-listesi').innerHTML = '';
            }
        }

        function renderStok(stokData, deficitAnalysis) {
            let html = '<table><tr><th>Aşama/Cins</th><th>M²</th><th>Eksik Sipariş</th><th>Eksik Ham</th></tr>';
            
            for (const [key, value] of Object.entries(stokData)) {
                
                // key: "BAROK 2 CM (Ham)", "BAROK 2 CM (Sivali)"
                const itemKey = key.substring(0, key.lastIndexOf(' (')); 
                const asama = key.substring(key.lastIndexOf('(') + 1, key.lastIndexOf(')'));
                const deficitInfo = deficitAnalysis[itemKey]; 
                
                let sivaliDeficitText = '-';
                let hamDeficitText = '-';

                if (asama === 'Sivali' && deficitInfo) {
                    if (deficitInfo.sivali_deficit > 0) {
                        sivaliDeficitText = `<span class="deficit-red">${deficitInfo.sivali_deficit} m² EKSİK</span>`;
                    }
                } 
                
                if (asama === 'Ham' && deficitInfo) {
                    if (deficitInfo.ham_deficit > 0) {
                         hamDeficitText = `<span class="deficit-red">${deficitInfo.ham_deficit} m² EKSİK</span>`;
                    } else if (deficitInfo.ham_coverage > 0) {
                         hamDeficitText = `<span class="production-blue">(Üretim Planı: ${deficitInfo.ham_coverage} m²)</span>`;
                    }
                }


                html += `<tr>
                    <td>${key}</td>
                    <td class="count-cell">${value} m²</td>
                    <td>${sivaliDeficitText}</td>
                    <td>${hamDeficitText}</td>
                </tr>`;
            }

            html += '</table>';
            document.getElementById('stok-tablosu').innerHTML = html;
        }

        function renderSiparisler(siparisler) {
            let html = '<table><tr><th>Sipariş Kod</th><th>Müşteri</th><th>Ürün Kod</th><th>M²</th><th>Durum</th></tr>';

            if (siparisler.length === 0) {
                html += '<tr><td colspan="5">Aktif veya tamamlanmış sipariş bulunmamaktadır.</td></tr>';
            } else {
                siparisler.forEach(s => {
                    let statusClass = s.durum === 'Bekliyor' ? 'status-bekliyor' : 'status-tamamlandi';
                    
                    html += `<tr>
                        <td><span class="siparis-kodu">${s.siparis_kodu}</span></td>
                        <td>${s.musteri}</td>
                        <td>${s.urun_kodu}</td>
                        <td class="count-cell">${s.bekleyen_m2} m²</td>
                        <td><span class="${statusClass}">${s.durum.toUpperCase()}</span></td>
                    </tr>`;
                });
            }
            html += '</table>';
            document.getElementById('siparis-listesi').innerHTML = html;
        }
    </script>