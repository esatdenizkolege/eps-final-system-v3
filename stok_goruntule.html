<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobil Stok & SipariÅŸ Takip</title>
    
    <style>
        /* --- MOBÄ°L Ä°Ã‡Ä°N DÄ°KEY VE BASÄ°T CSS --- */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: auto;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #007bff;
            font-size: 1.5em;
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 5px;
            border-bottom: 2px solid #007bff;
        }
        h2 {
            font-size: 1.2em;
            color: #333;
            margin-top: 25px;
            margin-bottom: 10px;
            padding: 5px 0;
            border-bottom: 1px solid #ddd;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            font-size: 0.9em;
        }
        th, td {
            border: 1px solid #e0e0e0;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #007bff;
            color: white;
            position: sticky; /* Mobil kaydÄ±rma iÃ§in baÅŸlÄ±k sabitlenir */
            top: 0;
            z-index: 10;
        }
        /* Durum Renklendirmeleri */
        .status-bekliyor {
            color: white;
            background-color: #dc3545; /* KÄ±rmÄ±zÄ± */
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status-tamamlandi {
            color: white;
            background-color: #28a745; /* YeÅŸil */
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
        /* Defisit Renklendirmeleri */
        .deficit-red {
            color: #dc3545;
            font-weight: bold;
        }
        .production-blue {
            color: #007bff;
            font-style: italic;
        }
        .loading, .error {
            text-align: center;
            padding: 20px;
            font-size: 1.1em;
            border-radius: 5px;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .count-cell {
            font-weight: bold;
        }
        .siparis-kodu {
            font-weight: bold;
            color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“± Mobil Stok & SipariÅŸ Takip</h1>

        <h2>ðŸ“¦ Stok ve Ãœretim Eksik Analizi (MÂ²)</h2>
        <p style="font-size: 0.8em; color: #666;">*SÄ±ralama: Cins/KalÄ±nlÄ±k ve AÅŸama (Ham/SÄ±valÄ±)</p>
        <div id="stok-tablosu">
            <div class="loading">Veriler Ã§ekiliyor...</div>
        </div>
        
        <h2>ðŸ“‹ TÃ¼m SipariÅŸler (Bekleyen & Tamamlanan)</h2>
        <div id="siparis-listesi">
            </div>

    </div>
    
    <script>
        // CRITICAL FIX: URL Ã§Ã¶zÃ¼mleme hatasÄ±nÄ± gidermek iÃ§in tam Render URL'i kodlanmÄ±ÅŸtÄ±r.
        // Bu URL'i, Render'daki canlÄ± uygulamanÄ±zÄ±n gerÃ§ek URL'i ile deÄŸiÅŸtirmeniz gerekebilir.
        const API_URL = "https://eps-final-system-v3.onrender.com/api/stok";

        document.addEventListener('DOMContentLoaded', fetchData);

        async function fetchData() {
            // YÃ¼kleme mesajlarÄ±nÄ± gÃ¶ster
            document.getElementById('stok-tablosu').innerHTML = '<div class="loading">ðŸ“¦ Stok verileri Ã§ekiliyor...</div>';
            document.getElementById('siparis-listesi').innerHTML = '<div class="loading">ðŸ“‹ SipariÅŸ verileri Ã§ekiliyor...</div>';
            
            try {
                const response = await fetch(API_URL);
                
                if (!response.ok) {
                    throw new Error(`API eriÅŸim hatasÄ±: HTTP ${response.status}`);
                }
                const data = await response.json();
                
                // API'den gelen veriler: "stok", "siparisler" (tÃ¼m sipariÅŸler) ve "deficit_analysis"
                renderStok(data.stok, data.deficit_analysis); 
                renderSiparisler(data.siparisler);

            } catch (error) {
                console.error("Fetch Error:", error); 
                document.getElementById('stok-tablosu').innerHTML = `<div class="error">BaÄŸlantÄ± HatasÄ±: API'ye ulaÅŸÄ±lamÄ±yor. LÃ¼tfen URL'i kontrol edin.</div>`;
                document.getElementById('siparis-listesi').innerHTML = '';
            }
        }

        function renderStok(stokData, deficitAnalysis) {
            let html = '<table><tr><th>AÅŸama/Cins</th><th>MÂ²</th><th>Eksik SipariÅŸ</th><th>Eksik Ham</th></tr>';
            
            // SÄ±ralanmÄ±ÅŸ anahtarlar (Ham ve SÄ±valÄ± yan yana gelecek ÅŸekilde)
            const sortedKeys = Object.keys(stokData).sort((a, b) => {
                const [cinsiA, kalinlikA, asamaA] = a.split(/ \((.*)\)/);
                const [cinsiB, kalinlikB, asamaB] = b.split(/ \((.*)\)/);
                
                if (cinsiA !== cinsiB) return cinsiA.localeCompare(cinsiB);
                if (kalinlikA !== kalinlikB) return kalinlikA.localeCompare(kalinlikB);
                
                // Ham (0) Ã¶nce, SÄ±valÄ± (1) sonra
                const orderMap = {'Ham': 0, 'Sivali': 1};
                return orderMap[asamaA.trim()] - orderMap[asamaB.trim()];
            });
            
            sortedKeys.forEach(key => {
                const value = stokData[key];
                
                // key: "BAROK 2 CM (Ham)", "BAROK 2 CM (Sivali)"
                // itemKey: "BAROK 2 CM"
                const itemKey = key.substring(0, key.lastIndexOf(' (')); 
                // asama: "Ham" veya "Sivali"
                const asama = key.substring(key.lastIndexOf('(') + 1, key.lastIndexOf(')'));
                const deficitInfo = deficitAnalysis[itemKey]; 
                
                let sivaliDeficitText = '-';
                let hamDeficitText = '-';

                // SIVALI SatÄ±rÄ±
                if (asama === 'Sivali' && deficitInfo) {
                    if (deficitInfo.sivali_deficit > 0) {
                        sivaliDeficitText = `<span class="deficit-red">${deficitInfo.sivali_deficit} mÂ² EKSÄ°K</span>`;
                    }
                } 
                
                // HAM SatÄ±rÄ±
                if (asama === 'Ham' && deficitInfo) {
                    // SipariÅŸin karÅŸÄ±lanmasÄ± iÃ§in gerekli ama stokta olmayan ham miktarÄ±
                    if (deficitInfo.ham_deficit > 0) {
                        hamDeficitText = `<span class="deficit-red">${deficitInfo.ham_deficit} mÂ² EKSÄ°K</span>`;
                    } 
                    // Mevcut ham stok ile karÅŸÄ±lanabilecek sipariÅŸ miktarÄ± (sadece bilgilendirme)
                    if (deficitInfo.ham_coverage > 0) {
                         // EÄŸer ham eksik yoksa veya zaten karÅŸÄ±lanÄ±yorsa Ã¼retim planÄ±nÄ± gÃ¶ster
                        sivaliDeficitText = `<span class="production-blue">(Ãœretim PlanÄ±: ${deficitInfo.ham_coverage} mÂ²)</span>`;
                    }
                }


                html += `<tr>
                    <td>${key}</td>
                    <td class="count-cell">${value} mÂ²</td>
                    <td>${sivaliDeficitText}</td>
                    <td>${hamDeficitText}</td>
                </tr>`;
            });

            html += '</table>';
            document.getElementById('stok-tablosu').innerHTML = html;
        }

        function renderSiparisler(siparisler) {
            // Sadece bekleyen sipariÅŸleri gÃ¶ster
            const bekleyenSiparisler = siparisler.filter(s => s.durum === 'Bekliyor');
            
            let html = '<table><tr><th>Kod</th><th>MÃ¼ÅŸteri</th><th>ÃœrÃ¼n</th><th>MÂ²</th><th>Durum</th></tr>';

            if (bekleyenSiparisler.length === 0) {
                html += '<tr><td colspan="5" style="text-align:center; color:green; font-weight:bold;">Tebrikler! Bekleyen sipariÅŸ bulunmamaktadÄ±r.</td></tr>';
            } else {
                bekleyenSiparisler.forEach(s => {
                    let statusClass = s.durum === 'Bekliyor' ? 'status-bekliyor' : 'status-tamamlandi';
                    
                    html += `<tr>
                        <td><span class="siparis-kodu">${s.siparis_kodu}</span></td>
                        <td>${s.musteri}</td>
                        <td>${s.urun_kodu}</td>
                        <td class="count-cell">${s.bekleyen_m2} mÂ²</td>
                        <td><span class="${statusClass}">${s.durum.toUpperCase()}</span></td>
                    </tr>`;
                });
            }
            html += '</table>';
            document.getElementById('siparis-listesi').innerHTML = html;
        }
    </script>
</body>
</html>