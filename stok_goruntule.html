<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobil Stok & SipariÅŸ Takip</title>
    
    <style>
        /* --- MOBÄ°L Ä°Ã‡Ä°N DÄ°KEY VE BASÄ°T CSS --- */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: auto;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #007bff;
            font-size: 1.5em;
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 5px;
            border-bottom: 2px solid #007bff;
        }
        h2 {
            font-size: 1.2em;
            color: #333;
            margin-top: 25px;
            margin-bottom: 10px;
            padding: 5px 0;
            border-bottom: 1px solid #ddd;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            font-size: 0.9em;
        }
        th, td {
            border: 1px solid #e0e0e0;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #007bff;
            color: white;
            position: sticky; 
            top: 0;
            z-index: 10;
        }
        /* Durum Renklendirmeleri */
        .status-bekliyor {
            color: white;
            background-color: #dc3545; 
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status-tamamlandi {
            color: white;
            background-color: #28a745; 
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
        /* Defisit Renklendirmeleri */
        .deficit-red {
            color: #dc3545;
            font-weight: bold;
        }
        .production-blue {
            color: #007bff;
            font-style: italic;
        }
        .loading, .error {
            text-align: center;
            padding: 20px;
            font-size: 1.1em;
            border-radius: 5px;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .count-cell {
            font-weight: bold;
        }
        .siparis-kodu {
            display: none;
        }
        .plan-box { 
            background-color: #e9fff5; 
            padding: 10px; 
            border-radius: 5px; 
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“± Mobil Stok & SipariÅŸ Takip</h1>
        
        <button onclick="fetchData()" style="margin-bottom: 15px; background-color:#28a745; color: white; padding: 10px 15px; border: none; border-radius: 5px; width: 100%;">
            ðŸ”„ Verileri Yenile
        </button>
        
        <div id="plan-ozeti">
            </div>

        <h2>ðŸ“¦ Stok ve Ãœretim Eksik Analizi (MÂ²)</h2>
        <p style="font-size: 0.8em; color: #666;">*SÄ±ralama: Cins/KalÄ±nlÄ±k ve AÅŸama (Ham/SÄ±valÄ±)</p>
        <div id="stok-tablosu">
            <div class="loading">Veriler Ã§ekiliyor...</div>
        </div>
        
        <h2>ðŸ“‹ TÃ¼m SipariÅŸler (Bekleyen & Tamamlanan)</h2>
        <div id="siparis-listesi">
        </div>

    </div>
    
    <script>
        // API'ye eriÅŸim adresi
        const API_URL = "https://eps-final-system-v3.onrender.com/api/stok";

        document.addEventListener('DOMContentLoaded', fetchData);

        async function fetchData() {
            document.getElementById('plan-ozeti').innerHTML = '<div class="loading" style="background: none;">Planlama verileri Ã§ekiliyor...</div>';
            document.getElementById('stok-tablosu').innerHTML = '<div class="loading">ðŸ“¦ Stok verileri Ã§ekiliyor...</div>';
            document.getElementById('siparis-listesi').innerHTML = '<div class="loading">ðŸ“‹ SipariÅŸ verileri Ã§ekiliyor...</div>';
            
            try {
                const response = await fetch(API_URL);
                
                if (!response.ok) {
                    throw new Error(`API eriÅŸim hatasÄ±: HTTP ${response.status}`);
                }
                const data = await response.json();
                
                renderPlanlama(data.toplam_gerekli_siva, data.gunluk_siva_m2, data.siva_plan_detay, data.sevkiyat_plan_detay);
                renderStok(data.stok, data.deficit_analysis); 
                renderSiparisler(data.siparisler); 
                
            } catch (error) {
                console.error("Fetch Error:", error); 
                document.getElementById('stok-tablosu').innerHTML = `<div class="error">BaÄŸlantÄ± HatasÄ±: API'ye ulaÅŸÄ±lamÄ±yor veya veri formatÄ± hatalÄ±.</div>`;
                document.getElementById('siparis-listesi').innerHTML = '';
            }
        }
        
        function renderPlanlama(toplam_eksi_m2, kapasite, sivaPlan, sevkiyatPlan) {
            let html = `<h2 style="color: #00a359;">ðŸš€ Ãœretim Planlama (Kapasite: ${kapasite} mÂ²/gÃ¼n)</h2>`;

            if (toplam_eksi_m2 > 0) {
                html += `<p style="font-weight: bold; color: darkred; font-size: 0.9em;">Toplam SÄ±va MÂ² EksiÄŸi: ${toplam_eksi_m2} mÂ²</p>`;
            } else {
                 html += `<p style="font-weight: bold; color: green; font-size: 0.9em;">SÄ±valÄ± malzeme ihtiyacÄ± stoktan karÅŸÄ±lanabiliyor.</p>`;
            }
            
            html += `
            <div style="display: flex; gap: 10px;">
                <div class="plan-box" style="flex: 1; background-color: #d8f5ff; border: 1px solid #17a2b8;">
                    <h3>SÄ±va Ãœretim PlanÄ± (5 GÃ¼n)</h3>
                    <table>`;
                    const sivaKeys = Object.keys(sivaPlan);
                    if (sivaKeys.length > 0) {
                        sivaKeys.forEach(gun => {
                            html += `<tr><td>GÃ¼n ${gun}</td><td>${sivaPlan[gun]} mÂ²</td></tr>`;
                        });
                    } else {
                        html += `<tr><td colspan="2">Ä°htiyaÃ§ yok.</td></tr>`;
                    }
                    html += `</table>
                </div>

                <div class="plan-box" style="flex: 1; background-color: #fff0d8; border: 1px solid #cc8400;">
                    <h3>Sevkiyat PlanÄ± (5 GÃ¼n)</h3>`;
                    const sevkiyatKeys = Object.keys(sevkiyatPlan);
                    if (sevkiyatKeys.length > 0) {
                        sevkiyatKeys.forEach(tarih => {
                            const sevkiyatlar = sevkiyatPlan[tarih];
                            const toplamM2 = sevkiyatlar.reduce((sum, s) => sum + s.bekleyen_m2, 0);

                            html += `
                                <h4 style="margin: 5px 0 2px 0; color: #0056b3; font-size: 0.9em;">${tarih} (${toplamM2} mÂ²)</h4>
                                <ul style="list-style: none; padding: 0; margin-left: 5px; font-size: 0.8em;">`;
                                    sevkiyatlar.forEach(s => {
                                        html += `<li>- ${s.urun_kodu}: ${s.bekleyen_m2} mÂ² (${s.musteri})</li>`;
                                    });
                            html += `</ul>`;
                        });
                    } else {
                        html += `<p style="font-size: 0.9em;">Ã–nÃ¼mÃ¼zdeki 5 gÃ¼n terminli sevkiyat yok.</p>`;
                    }

                    html += `
                </div>
            </div>`;

            document.getElementById('plan-ozeti').innerHTML = html;
        }


        function renderStok(stokData, deficitAnalysis) {
            // BaÅŸlÄ±klar: AÅŸama/Cins | MÂ² | Eksik SÄ±valÄ± MÂ² | Eksik Ham MÂ²
            let html = '<table><tr><th>AÅŸama/Cins</th><th>MÂ²</th><th>Eksik SÄ±valÄ± MÂ²</th><th>Eksik Ham MÂ²</th></tr>';
            
            // SÄ±ralanmÄ±ÅŸ anahtarlar
            const sortedKeys = Object.keys(stokData).sort((a, b) => {
                const [cinsiA, kalinlikA, asamaA] = a.split(/ \((.*)\)/);
                const [cinsiB, kalinlikB, asamaB] = b.split(/ \((.*)\)/);
                
                if (cinsiA !== cinsiB) return cinsiA.localeCompare(cinsiB);
                if (kalinlikA !== kalinlikB) return kalinlikA.localeCompare(kalinlikB);
                
                const orderMap = {'Ham': 0, 'Sivali': 1};
                return orderMap[asamaA.trim()] - orderMap[asamaB.trim()];
            });
            
            sortedKeys.forEach(key => {
                const value = stokData[key];
                
                const itemKey = key.substring(0, key.lastIndexOf(' (')); 
                const asama = key.substring(key.lastIndexOf('(') + 1, key.lastIndexOf(')'));
                const deficitInfo = deficitAnalysis[itemKey]; 
                
                let sivaliDeficitText = '-';
                let hamDeficitText = '-';
                let sivaliDeficit = 0;
                let hamDeficit = 0;
                let hamCoverage = 0;

                // Defisit DeÄŸerlerini Hesapla/Al
                if (deficitInfo) {
                    sivaliDeficit = deficitInfo.sivali_deficit || 0;
                    hamDeficit = deficitInfo.ham_deficit || 0;
                    hamCoverage = deficitInfo.ham_coverage || 0;
                }
                
                // SIVALI SatÄ±rÄ±
                if (asama === 'Sivali') {
                    if (sivaliDeficit > 0) {
                        sivaliDeficitText = `<span class="deficit-red">${sivaliDeficit} mÂ² EKSÄ°K</span>`;
                    }
                } 
                
                // HAM SatÄ±rÄ±
                if (asama === 'Ham') {
                    if (hamDeficit > 0) {
                        hamDeficitText = `<span class="deficit-red">${hamDeficit} mÂ² EKSÄ°K</span>`;
                    } 
                    if (hamCoverage > 0) {
                         sivaliDeficitText = `<span class="production-blue">(Ãœretim PlanÄ±: ${hamCoverage} mÂ²)</span>`;
                    }
                }

                // SÄ±fÄ±r StoklarÄ± Gizleme MantÄ±ÄŸÄ± (Sadece Pozitif/Negatif stok veya eksik sipariÅŸ varsa gÃ¶ster)
                if (value !== 0 || sivaliDeficit > 0 || hamDeficit > 0) {
                    html += `<tr>
                        <td>${key}</td>
                        <td class="count-cell">${value} mÂ²</td>
                        <td>${sivaliDeficitText}</td>
                        <td>${hamDeficitText}</td>
                    </tr>`;
                }
            });

            html += '</table>';
            document.getElementById('stok-tablosu').innerHTML = html;
        }

        // planlanan_is_gunu API'den siparisler objesi iÃ§inde geliyor.
        function renderSiparisler(siparisler) {
            const tumSiparisler = siparisler; 
            
            // YENÄ° BAÅžLIKLAR: Sip. Tarihi, MÃ¼ÅŸteri, ÃœrÃ¼n, MÂ², Durum, Termin, SÄ±valÄ± Zemin (GÃ¼n)
            let html = '<table><tr><th>Sip. Tarihi</th><th>MÃ¼ÅŸteri</th><th>ÃœrÃ¼n</th><th>MÂ²</th><th>Durum</th><th>Termin</th><th>SÄ±valÄ± Zemin (GÃ¼n)</th></tr>';

            if (tumSiparisler.length === 0) {
                html += '<tr><td colspan="7" style="text-align:center; color:#666; font-weight:bold;">Aktif veya tamamlanmÄ±ÅŸ sipariÅŸ bulunmamaktadÄ±r.</td></tr>';
            } else {
                tumSiparisler.forEach(s => {
                    let statusClass = s.durum === 'Bekliyor' ? 'status-bekliyor' : 'status-tamamlandi';
                    let bekleyenM2 = s.durum === 'Bekliyor' ? `${s.bekleyen_m2} mÂ²` : '0 mÂ²';
                    
                    let planlananGunText = '-';
                    if (s.durum === 'Bekliyor') {
                        if (s.planlanan_is_gunu === 0) {
                            planlananGunText = `<span style="color: green;">Stoktan</span>`;
                        } else if (s.planlanan_is_gunu > 0) {
                            planlananGunText = `<b>${s.planlanan_is_gunu} GÃ¼n</b>`;
                        } else {
                            planlananGunText = `Kapasite Yok`;
                        }
                    }
                    
                    html += `<tr>
                        <td>${s.siparis_tarihi}</td>
                        <td>${s.musteri}</td>
                        <td>${s.urun_kodu}</td>
                        <td class="count-cell">${bekleyenM2}</td>
                        <td><span class="${statusClass}">${s.durum.toUpperCase()}</span></td>
                        <td>${s.termin_tarihi}</td>
                        <td>${planlananGunText}</td>
                    </tr>`;
                });
            }
            html += '</table>';
            document.getElementById('siparis-listesi').innerHTML = html;
        }
    </script>
</body>
</html>